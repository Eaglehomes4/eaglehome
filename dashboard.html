<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eagle Homes | Property Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Favicon Section -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="manifest" href="site.webmanifest">
    
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
        }
        [x-cloak] { display: none !important; }
        .sidebar-link.active { 
            background-color: #eff6ff; 
            color: #2563eb; 
            border-right: 4px solid #2563eb; 
        }
        .sticky-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 50;
            border-bottom: 1px solid #e5e7eb;
        }
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body x-data="managementSystem()" x-init="init()" class="min-h-screen bg-gray-50">
    <!-- Desktop Sidebar -->
    <aside class="sidebar w-64 bg-white border-r border-gray-200 flex flex-col fixed h-full z-50 no-print hidden lg:flex">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i class="fas fa-home text-white text-lg"></i>
            </div>
            <h1 class="font-black text-xl tracking-tighter text-slate-800 uppercase">Eagle Homes</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto scrollbar-thin">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-4 mb-2">Main Menu</p>
            <a href="#" @click.prevent="activeTab = 'dashboard'" 
               :class="activeTab === 'dashboard' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-tachometer-alt w-5 h-5"></i>
                Dashboard
            </a>
            <a href="#" @click.prevent="activeTab = 'tenants'" 
               :class="activeTab === 'tenants' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-users w-5 h-5"></i>
                Tenants
            </a>
            <a href="#" @click.prevent="activeTab = 'utilities'" 
               :class="activeTab === 'utilities' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-bolt w-5 h-5"></i>
                Utility Entry
            </a>
            <a href="#" @click.prevent="activeTab = 'payments'" 
               :class="activeTab === 'payments' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-university w-5 h-5"></i>
                Payments
            </a>
            <a href="#" @click.prevent="activeTab = 'notifications'" 
               :class="activeTab === 'notifications' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-bell w-5 h-5"></i>
                Notifications
            </a>
            <a href="#" @click.prevent="activeTab = 'reports'" 
               :class="activeTab === 'reports' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-chart-bar w-5 h-5"></i>
                Reports
            </a>
            <a href="#" @click.prevent="activeTab = 'statement'" 
               :class="activeTab === 'statement' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-file-invoice-dollar w-5 h-5"></i>
                Landlord Statement
            </a>

            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-4 mt-8 mb-2">Administration</p>
            <a href="#" @click.prevent="activeTab = 'properties'" 
               :class="activeTab === 'properties' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-building w-5 h-5"></i>
                Properties
            </a>
            <a href="#" @click.prevent="activeTab = 'settings'" 
               :class="activeTab === 'settings' ? 'sidebar-link active' : ''"
               class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-cog w-5 h-5"></i>
                Settings
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100 space-y-3">
            <!-- User Role Selector -->
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Current Role</label>
                <select x-model="userRole" @change="onRoleChange()"
                        class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="owner">Owner</option>
                    <option value="secretary">Secretary</option>
                </select>
                <p class="text-xs text-gray-500 mt-1" x-text="userRole === 'owner' ? 'Full edit permissions' : 'Read-only mode'"></p>
            </div>
            
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-blue-600 text-sm"></i>
                </div>
                <div>
                    <p class="text-sm font-bold text-gray-700" x-text="userRole === 'owner' ? 'Owner' : 'Secretary'"></p>
                    <p class="text-xs text-gray-500">Logged In</p>
                </div>
            </div>
            <button @click="logout()" class="w-full text-red-500 font-bold text-sm py-2 hover:bg-red-50 rounded-lg transition flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </aside>

    <!-- Mobile Sidebar & Overlay -->
    <div x-show="isMobileMenuOpen" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 lg:hidden" x-cloak>
        
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" @click="isMobileMenuOpen = false"></div>

        <div x-show="isMobileMenuOpen"
             x-transition:enter="transition ease-out duration-300 transform"
             x-transition:enter-start="-translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-200 transform"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="-translate-x-full"
             class="fixed inset-y-0 left-0 w-72 bg-white shadow-2xl flex flex-col p-6">
            
            <div class="flex items-center justify-between mb-8 pb-4 border-b border-slate-100">
                <span class="font-bold text-xl text-blue-600">EAGLE HOMES</span>
                <button @click="isMobileMenuOpen = false" class="p-2 bg-slate-50 rounded-full text-slate-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <nav class="space-y-4">
                <button @click="activeTab = 'dashboard'; isMobileMenuOpen = false" 
                        :class="activeTab === 'dashboard' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </button>

                <button @click="activeTab = 'tenants'; isMobileMenuOpen = false" 
                        :class="activeTab === 'tenants' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-users"></i>
                    Tenants
                </button>

                <button @click="activeTab = 'utilities'; isMobileMenuOpen = false" 
                        :class="activeTab === 'utilities' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-bolt"></i>
                    Utility Entry
                </button>

                <button @click="activeTab = 'payments'; isMobileMenuOpen = false" 
                        :class="activeTab === 'payments' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-university"></i>
                    Payments
                </button>

                <button @click="activeTab = 'notifications'; isMobileMenuOpen = false" 
                        :class="activeTab === 'notifications' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-bell"></i>
                    Notifications
                </button>

                <button @click="activeTab = 'reports'; isMobileMenuOpen = false" 
                        :class="activeTab === 'reports' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-chart-bar"></i>
                    Reports
                </button>

                <button @click="activeTab = 'statement'; isMobileMenuOpen = false" 
                        :class="activeTab === 'statement' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-file-invoice-dollar"></i>
                    Landlord Statement
                </button>

                <button @click="activeTab = 'properties'; isMobileMenuOpen = false" 
                        :class="activeTab === 'properties' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-building"></i>
                    Properties
                </button>

                <button @click="activeTab = 'settings'; isMobileMenuOpen = false" 
                        :class="activeTab === 'settings' ? 'bg-blue-50 text-blue-600' : 'text-slate-600'"
                        class="w-full text-left p-4 font-bold rounded-2xl flex items-center gap-3 transition">
                    <i class="fas fa-cog"></i>
                    Settings
                </button>
            </nav>

            <div class="mt-auto pt-6 border-t border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Logged in as</p>
                <div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between">
                    <span class="text-xs font-bold capitalize" x-text="userRole"></span>
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                </div>
                <button @click="logout()" class="w-full mt-4 text-red-500 font-bold text-sm py-2 hover:bg-red-50 rounded-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 w-full min-w-0 overflow-y-auto p-4 md:p-8 ml-0 lg:ml-64 min-h-screen">
        <!-- Mobile Hamburger Button -->
        <button @click="isMobileMenuOpen = true" class="lg:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors fixed top-4 left-4 z-40 bg-white shadow-md">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
        </button>

        <!-- Dashboard Tab -->
        <div x-show="activeTab === 'dashboard'" x-cloak>
            <div class="sticky-header p-6 md:p-8 pb-6 mt-12 lg:mt-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-800">Property Dashboard</h2>
                        <p class="text-gray-500 font-medium">Eagle Homes Portfolio • <span class="text-blue-600 font-bold" x-text="currentMonth"></span></p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 md:gap-4">
                        <button x-show="userRole === 'owner'" 
                                @click="toggleEditMode()"
                                :class="editMode ? 'bg-amber-500 hover:bg-amber-600' : 'bg-blue-600 hover:bg-blue-700'"
                                class="text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                            <i :class="editMode ? 'fas fa-save' : 'fas fa-edit'"></i>
                            <span x-text="editMode ? 'Save All Changes' : 'Edit Mode'"></span>
                        </button>
                        
                        <button @click="exportToPDF('dashboard')" class="bg-red-600 text-white px-4 md:px-5 py-2 md:py-2.5 rounded-xl font-semibold hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i>
                            <span class="hidden md:inline">Export PDF</span>
                        </button>
                        
                        <button @click="rolloverMonth()" class="bg-green-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition flex items-center gap-2">
                            <i class="fas fa-forward"></i>
                            <span class="hidden md:inline">Rollover Month</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 md:p-8 pt-6">
                <!-- Stats Dashboard -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Total Expected Rent</p>
                                <h3 class="text-xl md:text-2xl font-black text-slate-800">Ksh <span x-text="formatNumber(totalRevenue)"></span></h3>
                            </div>
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-money-bill-wave text-blue-600 text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-3">Monthly expected revenue</p>
                    </div>
                    
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Total Deposits Held</p>
                                <h3 class="text-xl md:text-2xl font-black text-emerald-600">Ksh <span x-text="formatNumber(totalDeposits)"></span></h3>
                            </div>
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-shield-alt text-emerald-600 text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-3">Security deposits held</p>
                    </div>
                    
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Occupancy Rate</p>
                                <h3 class="text-xl md:text-2xl font-black text-purple-600"><span x-text="occupancyRate"></span>%</h3>
                            </div>
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-chart-line text-purple-600 text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                            <div class="bg-purple-600 h-2.5 rounded-full" :style="{ width: occupancyRate + '%' }"></div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Properties</p>
                                <h3 class="text-xl md:text-2xl font-black text-orange-600"><span x-text="Object.keys(properties).length"></span></h3>
                            </div>
                            <div class="w-10 h-10 md:w-12 md:h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-building text-orange-600 text-lg md:text-xl"></i>
                            </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-3">Total buildings managed</p>
                    </div>
                </div>

                <!-- Unidentified Payments Alert -->
                <div x-show="unidentifiedPayments.length > 0" class="mb-6">
                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-r-xl flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-exclamation-triangle text-amber-600 text-xl"></i>
                            <div>
                                <p class="text-amber-800 font-bold">Unidentified Payments Detected</p>
                                <p class="text-amber-600 text-sm">There are <span x-text="unidentifiedPayments.length"></span> payments with missing or wrong house numbers.</p>
                            </div>
                        </div>
                        <button @click="activeTab = 'payments'" class="bg-amber-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-amber-700 transition">
                            Fix Issues Now
                        </button>
                    </div>
                </div>

                <!-- Properties Overview -->
                <div class="mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                        <h3 class="text-xl font-bold text-slate-800">Properties Overview</h3>
                        <div class="flex flex-wrap gap-2 md:gap-3">
                            <select x-model="selectedBuilding" 
                                    class="bg-gray-50 border border-gray-200 p-2 rounded-lg text-sm font-medium focus:ring-2 focus:ring-blue-500 w-full md:w-auto">
                                <option value="">All Properties</option>
                                <template x-for="(property, name) in properties" :key="name">
                                    <option :value="name" x-text="name"></option>
                                </template>
                            </select>
                            <button x-show="userRole === 'owner'" @click="showAddPropertyModal = true"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition flex items-center gap-2 w-full md:w-auto">
                                <i class="fas fa-plus"></i>
                                Add Property
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
                        <template x-for="(property, name) in filteredProperties" :key="name">
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden property-card transition-all">
                                <div class="p-4 md:p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h4 class="font-bold text-slate-800 text-lg" x-text="name"></h4>
                                            <p class="text-sm text-gray-500" x-text="property.length + ' units'"></p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button @click="viewProperty(name)" class="text-blue-600 hover:text-blue-800 p-1">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button x-show="userRole === 'owner'" @click="editProperty(name)" class="text-amber-600 hover:text-amber-800 p-1">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button x-show="userRole === 'owner'" @click="deleteProperty(name)" class="text-red-600 hover:text-red-800 p-1">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-xs text-gray-400 font-medium uppercase">Total Rent</p>
                                            <p class="font-bold text-lg text-slate-800">Ksh <span x-text="formatNumber(calculatePropertyTotal(name, 'rent'))"></span></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 font-medium uppercase">Occupancy</p>
                                            <div class="flex items-center gap-2">
                                                <div class="w-full bg-gray-200 rounded-full h-2">
                                                    <div class="bg-green-500 h-2 rounded-full" 
                                                         :style="{ width: calculateOccupancyRate(name) + '%' }"></div>
                                                </div>
                                                <span class="text-sm font-medium" x-text="calculateOccupancyRate(name) + '%'"></span>
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-400 font-medium uppercase">Vacant Units</p>
                                            <p class="font-medium text-red-600" x-text="countVacantUnits(name)"></p>
                                        </div>
                                    </div>
                                    
                                    <button @click="viewProperty(name)" 
                                            class="w-full mt-6 bg-blue-50 text-blue-600 hover:bg-blue-100 py-2 rounded-lg font-medium transition">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenants Management Tab -->
        <div x-show="activeTab === 'tenants'" x-cloak>
            <div class="sticky-header p-6 md:p-8 pb-6 mt-12 lg:mt-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-800">Tenant Management</h2>
                        <p class="text-gray-500 font-medium">Manage all tenants across properties</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 md:gap-4">
                        <button x-show="userRole === 'owner'" @click="showAddTenantModal = true"
                                class="bg-green-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            <span class="hidden md:inline">Add New Tenant</span>
                        </button>
                        <button @click="exportToPDF('tenants')" class="bg-red-600 text-white px-4 md:px-5 py-2 md:py-2.5 rounded-xl font-semibold hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i>
                            <span class="hidden md:inline">Export PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 md:p-8 pt-6">
                <!-- Tenants Table -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="table-container">
                        <table class="w-full min-w-[1200px]">
                            <thead class="bg-gray-50">
                                <tr class="text-xs text-gray-400 uppercase tracking-widest border-b border-gray-100">
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Property</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Unit</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Tenant Name</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Phone</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Rent (Ksh)</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Deposit</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Arrears</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Status</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="tenant in allTenants" :key="tenant.id">
                                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                                        <td class="px-4 md:px-6 py-4" x-text="tenant.property"></td>
                                        <td class="px-4 md:px-6 py-4 font-medium" x-text="tenant.unit"></td>
                                        <td class="px-4 md:px-6 py-4">
                                            <div class="flex items-center gap-2">
                                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                    <i class="fas fa-user text-blue-600 text-sm"></i>
                                                </div>
                                                <span x-text="tenant.name"></span>
                                            </div>
                                        </td>
                                        <td class="px-4 md:px-6 py-4" x-text="tenant.phone || '-'"></td>
                                        <td class="px-4 md:px-6 py-4 font-bold" x-text="formatNumber(tenant.rent)"></td>
                                        <td class="px-4 md:px-6 py-4 font-medium text-emerald-600" x-text="formatNumber(tenant.deposit)"></td>
                                        <td class="px-4 md:px-6 py-4">
                                            <span x-text="formatNumber(tenant.arrears || 0)" :class="(tenant.arrears || 0) > 0 ? 'text-red-600 font-bold' : 'text-green-600'"></span>
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <span :class="getStatusClass(tenant.status)" 
                                                  class="px-2 py-1 rounded text-xs font-medium">
                                                <span x-text="getStatusText(tenant.status)"></span>
                                            </span>
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <div class="flex gap-2">
                                                <button @click="editTenant(tenant)" 
                                                        class="text-blue-600 hover:text-blue-800 p-1" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button @click="viewTenantDetails(tenant)" 
                                                        class="text-green-600 hover:text-green-800 p-1" title="View">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button x-show="userRole === 'owner'" @click="deleteTenant(tenant)" 
                                                        class="text-red-600 hover:text-red-800 p-1" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Utility Entry Tab -->
        <div x-show="activeTab === 'utilities'" x-cloak>
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 mt-12 lg:mt-0">
                <div>
                    <h1 class="text-2xl md:text-3xl font-extrabold text-slate-900">Digital Utility Ledger</h1>
                    <p class="text-slate-500 font-medium text-sm">Portfolio • <span x-text="currentMonth"></span></p>
                </div>
                <div class="flex gap-2">
                    <button @click="exportToPDF('utilities')" class="bg-red-600 text-white px-4 md:px-5 py-2 md:py-2.5 rounded-xl font-semibold hover:bg-red-700 transition flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i>
                        <span>Export PDF</span>
                    </button>
                </div>
            </header>

            <div class="w-full">
                <div class="bg-white rounded-2xl md:rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                    <div class="p-6 md:p-8 bg-blue-600 text-white">
                        <h3 class="text-lg md:text-xl font-bold">Input Charges</h3>
                        <p class="text-blue-100 text-xs md:text-sm">Enter water, garbage, and penalties (manual entry only).</p>
                    </div>

                    <div class="table-container">
                        <table class="w-full text-sm md:text-base">
                            <thead>
                                <tr class="text-slate-400 text-xs font-bold uppercase border-b border-slate-100">
                                    <th class="p-4 text-left whitespace-nowrap">House</th>
                                    <th class="p-4 text-left whitespace-nowrap">Tenant</th>
                                    <th class="p-4 text-left whitespace-nowrap">Water</th>
                                    <th class="p-4 text-left whitespace-nowrap">Garbage</th>
                                    <th class="p-4 text-left whitespace-nowrap">Penalty</th>
                                    <th class="p-4 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <template x-for="(tenant, index) in allTenants" :key="index">
                                    <tr class="group">
                                        <td class="p-4 font-mono text-blue-600 font-bold" x-text="tenant.property + '-' + tenant.unit"></td>
                                        <td class="p-4 font-medium truncate max-w-[100px] md:max-w-none" x-text="tenant.name"></td>
                                        <td class="p-4"><input type="number" :id="'water-' + tenant.id" class="w-20 md:w-24 bg-slate-50 border border-slate-200 rounded-lg px-2 py-1" placeholder="0.00"></td>
                                        <td class="p-4 text-slate-400">200</td>
                                        <td class="p-4">
                                            <input type="number" :id="'penalty-' + tenant.id" class="w-20 md:w-24 bg-slate-50 border border-slate-200 rounded-lg px-2 py-1" placeholder="0.00">
                                            <div class="text-xs text-gray-500 mt-1">Manual entry only</div>
                                        </td>
                                        <td class="p-4 text-center">
                                            <button @click="saveHouseUtilities(tenant.id)" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-xl font-bold text-xs md:text-sm hover:bg-blue-600 hover:text-white transition">Update</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Tab -->
        <div x-show="activeTab === 'payments'" x-cloak>
            <div x-data="paymentManager()" x-init="init()">
                <div class="p-6 md:p-8 pb-0 mt-12 lg:mt-0">
                    
                    <!-- Unidentified Payments Alert -->
                    <template x-if="unidentifiedPayments.length > 0">
                        <div class="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl flex justify-between items-center animate-pulse shadow-md">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                                <div>
                                    <p class="text-red-800 font-black text-sm uppercase tracking-wide">Action Required: New Suspense Payment</p>
                                    <p class="text-red-600 text-xs font-medium">A payment is waiting to be assigned to a house.</p>
                                </div>
                            </div>
                            <button @click="pathFilter = 'all'; paymentSearch = ''" 
                                    class="bg-red-600 text-white px-5 py-2 rounded-lg text-xs font-black hover:bg-red-700">
                                Resolve Now
                            </button>
                        </div>
                    </template>

                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-slate-800 tracking-tight">Financial Ledger</h2>
                            <div class="flex items-center gap-4 mt-2">
                                <nav class="flex space-x-1 bg-slate-100 p-1 rounded-xl text-[10px] font-black uppercase tracking-tighter">
                                    <button @click="pathFilter = 'all'" :class="pathFilter === 'all' ? 'bg-white shadow text-blue-600' : 'text-slate-500'" class="px-3 py-1.5 rounded-lg transition">All</button>
                                    <button @click="pathFilter = 'Family Bank'" :class="pathFilter === 'Family Bank' ? 'bg-orange-500 text-white' : 'text-slate-500'" class="px-3 py-1.5 rounded-lg transition">Family Bank</button>
                                    <button @click="pathFilter = 'Co-op Bank'" :class="pathFilter === 'Co-op Bank' ? 'bg-green-600 text-white' : 'text-slate-500'" class="px-3 py-1.5 rounded-lg transition">Co-op Bank</button>
                                    <button @click="pathFilter = 'Payslip'" :class="pathFilter === 'Payslip' ? 'bg-purple-600 text-white' : 'text-slate-500'" class="px-3 py-1.5 rounded-lg transition">Payslips</button>
                                    <button @click="pathFilter = 'M-Pesa'" :class="pathFilter === 'M-Pesa' ? 'bg-emerald-500 text-white' : 'text-slate-500'" class="px-3 py-1.5 rounded-lg transition">M-Pesa</button>
                                </nav>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap items-center gap-2">
                            <button @click="fetchPayments()" 
                                    class="bg-white border-2 border-slate-100 p-3 rounded-xl hover:bg-slate-50 shadow-sm text-slate-500 group">
                                <i class="fas fa-sync-alt group-active:rotate-180 transition duration-500"></i>
                            </button>
                            <button @click="exportPaymentsPDF()" class="bg-red-600 text-white px-4 py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i>
                                <span>Export PDF</span>
                            </button>
                        </div>
                    </div>

                    <div class="relative mb-6">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" x-model="paymentSearch" @input="filterPayments" 
                               placeholder="Search Transaction ID, Phone, or House..." 
                               class="w-full pl-12 pr-4 py-4 bg-white border border-slate-200 rounded-2xl shadow-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>

                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden overflow-x-auto">
                        <table class="w-full text-left border-collapse min-w-[1100px]">
                            <thead class="bg-slate-50/50">
                                <tr class="text-[11px] uppercase tracking-widest text-slate-400 font-bold border-b border-slate-100">
                                    <th class="px-6 py-5">Date/Time</th>
                                    <th class="px-6 py-5">Path</th>
                                    <th class="px-6 py-5">House / Ref</th>
                                    <th class="px-6 py-5 text-emerald-600">Amount</th>
                                    <th class="px-6 py-5">Waterfall Deductions</th>
                                    <th class="px-6 py-5">Status</th>
                                    <th class="px-6 py-5 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <template x-for="p in filteredPayments" :key="p.id">
                                    <tr class="hover:bg-slate-50/50 transition-colors" :class="p.status === 'Unidentified' ? 'bg-red-50/40 border-l-4 border-l-red-500' : ''">
                                        <td class="px-6 py-4">
                                            <div class="font-bold text-slate-700 text-xs" x-text="p.date"></div>
                                            <div class="text-[10px] text-slate-400 uppercase" x-text="p.time"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class="px-2 py-1 rounded text-[9px] font-black uppercase border tracking-tighter"
                                                  :class="getPathClass(p.method)" x-text="p.method"></span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="font-black text-blue-600 text-sm" x-text="p.house_id || 'PENDING'"></div>
                                            <div class="text-[10px] font-mono text-slate-400" x-text="p.reference"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-base font-black text-slate-900" x-text="formatNumber(p.amount)"></div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="bg-slate-50 p-2 rounded-lg border border-slate-100 min-w-[160px]">
                                                <template x-if="!p.deductions_json || p.deductions_json === '{}'">
                                                    <span class="text-[10px] text-slate-400 italic">No deductions applied</span>
                                                </template>
                                                <div class="space-y-1">
                                                    <template x-for="(amt, type) in JSON.parse(p.deductions_json || '{}')" :key="type">
                                                        <div class="flex justify-between text-[10px]">
                                                            <span class="text-slate-500 capitalize" x-text="type"></span>
                                                            <span class="font-bold text-slate-700" x-text="'-' + formatNumber(amt)"></span>
                                                        </div>
                                                    </template>
                                                    <div x-show="p.overpayment_balance > 0" class="flex justify-between text-[10px]">
                                                        <span class="text-emerald-600">Overpayment</span>
                                                        <span class="font-bold text-emerald-700" x-text="'+' + formatNumber(p.overpayment_balance)"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span :class="p.status === 'Processed' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700 animate-pulse'" 
                                                  class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest block text-center" x-text="p.status"></span>
                                            <div x-show="p.refund_id" class="text-[8px] text-purple-600 mt-1">
                                                Refund: <span x-text="p.refund_id"></span>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <button x-show="p.status === 'Unidentified'" @click="openResolveModal(p)" 
                                                    class="text-red-500 hover:text-red-700 p-2 transition" title="Resolve Payment">
                                                <i class="fas fa-fingerprint text-lg"></i>
                                            </button>
                                            <button x-show="p.overpayment_balance > 0" @click="processRefund(p)" 
                                                    class="text-purple-500 hover:text-purple-700 p-2 transition" title="Process Refund">
                                                <i class="fas fa-money-bill-wave"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div x-show="activeTab === 'notifications'" x-cloak>
            <div class="sticky-header p-6 md:p-8 pb-6 mt-12 lg:mt-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-800">Notifications & Messages</h2>
                        <p class="text-gray-500 font-medium">Send automated and manual notifications to tenants</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 md:gap-4">
                        <button @click="sendBroadcastMessage()" class="bg-blue-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition flex items-center gap-2">
                            <i class="fas fa-bullhorn"></i>
                            <span class="hidden md:inline">Send Broadcast</span>
                        </button>
                        <button @click="sendArrearsReminders()" class="bg-amber-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:bg-amber-700 transition flex items-center gap-2">
                            <i class="fas fa-bell"></i>
                            <span class="hidden md:inline">Send Arrears Reminders</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 md:p-8 pt-6">
                <!-- Message Templates -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mb-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">Broadcast Message</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Message</label>
                                <textarea x-model="broadcastMessage" rows="4" 
                                          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" 
                                          placeholder="Enter your message to all tenants..."></textarea>
                            </div>
                            <button @click="sendBroadcastMessage()" 
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                                Send to All Tenants
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4">Automated Messages</h3>
                        <div class="space-y-4">
                            <div class="p-3 bg-amber-50 rounded-lg border border-amber-100">
                                <p class="text-sm font-medium text-amber-800">Arrears Reminder</p>
                                <p class="text-xs text-amber-600">Automatically sent on the 5th of every month to tenants with arrears</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-lg border border-green-100">
                                <p class="text-sm font-medium text-green-800">Holiday Messages</p>
                                <p class="text-xs text-green-600">Automatic holiday greetings for Mashujaa Day, Madaraka Day, and Christmas</p>
                            </div>
                            <div class="text-xs text-gray-500">
                                <p><i class="fas fa-info-circle mr-1"></i> Messages are sent only to tenants with phone numbers saved</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Log -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-bold text-slate-800">Message History</h3>
                    </div>
                    <div class="table-container">
                        <table class="w-full min-w-[800px]">
                            <thead class="bg-gray-50">
                                <tr class="text-xs text-gray-400 uppercase tracking-widest border-b border-gray-100">
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Date</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Type</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Recipient</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Message</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="notification in notifications" :key="notification.id">
                                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                                        <td class="px-4 md:px-6 py-4" x-text="notification.date"></td>
                                        <td class="px-4 md:px-6 py-4">
                                            <span :class="notification.type === 'broadcast' ? 'bg-blue-100 text-blue-800' : notification.type === 'arrears' ? 'bg-amber-100 text-amber-800' : 'bg-green-100 text-green-800'" 
                                                  class="px-2 py-1 rounded text-xs font-medium" x-text="notification.type"></span>
                                        </td>
                                        <td class="px-4 md:px-6 py-4" x-text="notification.recipient || 'All Tenants'"></td>
                                        <td class="px-4 md:px-6 py-4 text-sm" x-text="notification.message"></td>
                                        <td class="px-4 md:px-6 py-4">
                                            <span :class="notification.status === 'sent' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" 
                                                  class="px-2 py-1 rounded text-xs font-medium" x-text="notification.status"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div x-show="activeTab === 'reports'" x-cloak>
            <div class="sticky-header p-6 md:p-8 pb-6 mt-12 lg:mt-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-800">Financial Reports</h2>
                        <p class="text-gray-500 font-medium">Detailed financial analysis and reports</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 md:gap-4">
                        <button @click="exportToPDF('reports')" 
                                class="bg-red-600 text-white px-4 md:px-5 py-2 md:py-2.5 rounded-xl font-semibold hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i>
                            <span class="hidden md:inline">Export PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 md:p-8 pt-6">
                <!-- Report Results -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <!-- Summary Stats -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-6">Financial Summary</h3>
                        <div class="space-y-6">
                            <div>
                                <p class="text-sm text-gray-500 mb-2">Total Revenue</p>
                                <h4 class="text-2xl font-black text-slate-800">Ksh <span x-text="formatNumber(totalRevenue)"></span></h4>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-500 mb-2">Rent Collected</p>
                                    <h4 class="text-xl font-bold text-emerald-600">Ksh <span x-text="formatNumber(totalCollected)"></span></h4>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-2">Outstanding Arrears</p>
                                    <h4 class="text-xl font-bold text-red-600">Ksh <span x-text="formatNumber(totalArrears)"></span></h4>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-2">Overpayment Balance</p>
                                    <h4 class="text-xl font-bold text-purple-600">Ksh <span x-text="formatNumber(totalOverpayment)"></span></h4>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500 mb-2">Refunds Processed</p>
                                    <h4 class="text-xl font-bold text-amber-600">Ksh <span x-text="formatNumber(totalRefunds)"></span></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Property Performance -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-6">Top Properties</h3>
                        <div class="space-y-4">
                            <template x-for="property in topProperties" :key="property.name">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-medium text-slate-800" x-text="property.name"></p>
                                        <p class="text-sm text-gray-500" x-text="property.occupancy + '% occupancy'"></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-bold text-slate-800">Ksh <span x-text="formatNumber(property.revenue)"></span></p>
                                        <p class="text-xs" :class="property.collectionRate >= 90 ? 'text-emerald-600' : 'text-amber-600'">
                                            <span x-text="property.collectionRate + '%'"></span> collected
                                        </p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Landlord Statement Tab -->
        <div x-show="activeTab === 'statement'" x-cloak>
            <div class="sticky-header p-6 md:p-8 pb-6 mt-12 lg:mt-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-800">Landlord Statement</h2>
                        <p class="text-gray-500 font-medium">Generate and manage landlord remittance statements</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 md:gap-4">
                        <button @click="exportStatementPDF()" 
                                class="bg-red-600 text-white px-4 md:px-5 py-2 md:py-2.5 rounded-xl font-semibold hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i>
                            <span class="hidden md:inline">Export PDF</span>
                        </button>
                        <button @click="generateStatement()" 
                                class="bg-green-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            <span class="hidden md:inline">Generate Statement</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 md:p-8 pt-6">
                <!-- Statement Controls -->
                <div class="mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Month</label>
                            <input type="month" x-model="statementMonth" 
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Property</label>
                            <select x-model="selectedBuilding" 
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                                <option value="">All Properties</option>
                                <template x-for="(property, name) in properties" :key="name">
                                    <option :value="name" x-text="name"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Commission Rate (%)</label>
                            <input type="number" x-model="commissionRate" step="0.01"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex items-end">
                            <button @click="saveStatement()" 
                                    class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition">
                                Save Statement
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statement Table -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Statement Data</h3>
                        <button @click="addNewRow()" class="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Add Row
                        </button>
                    </div>
                    <div class="table-container">
                        <table class="w-full min-w-[1200px]">
                            <thead class="bg-gray-50">
                                <tr class="text-xs text-gray-400 uppercase tracking-widest border-b border-gray-100">
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Unit</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Tenant Name</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Monthly Rent (Ksh)</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Amount Paid</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Deposit</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Garbage</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Water & Other Bills</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Remarks</th>
                                    <th class="px-4 md:px-6 py-4 font-bold text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(tenant, index) in statementData" :key="index">
                                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="text" x-model="tenant.unit" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="text" x-model="tenant.name" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="number" x-model="tenant.monthlyrent" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="number" x-model="tenant.amountPaid" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="number" x-model="tenant.deposit" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="number" x-model="tenant.garbage" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="number" x-model="tenant.Water & other_bills" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <input type="text" x-model="tenant.remarks" 
                                                   class="w-full border border-gray-300 rounded px-2 py-1">
                                        </td>
                                        <td class="px-4 md:px-6 py-4">
                                            <button @click="removeRow(index)" class="text-red-600 hover:text-red-800">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Expenses Section -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">Operational Expenses</h3>
                        <button @click="addExpense()" class="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Add Expense
                        </button>
                    </div>
                    <div class="p-4">
                        <template x-for="(expense, index) in expenses" :key="index">
                            <div class="flex gap-4 mb-3">
                                <input type="text" x-model="expense.description" 
                                       placeholder="Expense description" 
                                       class="flex-1 border border-gray-300 rounded px-3 py-2">
                                <input type="number" x-model="expense.amount" 
                                       placeholder="Amount" 
                                       class="w-32 border border-gray-300 rounded px-3 py-2">
                                <button @click="removeExpense(index)" class="text-red-600 hover:text-red-800 px-3">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                    <h3 class="text-xl font-bold text-slate-800 mb-6">Statement Summary</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-500 mb-2">Total Rent Collected</p>
                            <h4 class="text-xl font-bold text-blue-600">Ksh <span x-text="formatNumber(totalRentCollected)"></span></h4>
                        </div>
                        <div class="bg-amber-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-500 mb-2">Commission (<span x-text="commissionRate"></span>%)</p>
                            <h4 class="text-xl font-bold text-amber-600">Ksh <span x-text="formatNumber(commissionAmount)"></span></h4>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-500 mb-2">Total Expenses</p>
                            <h4 class="text-xl font-bold text-red-600">Ksh <span x-text="formatNumber(totalExpenses)"></span></h4>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-500 mb-2">Net to Landlord</p>
                            <h4 class="text-xl font-bold text-green-600">Ksh <span x-text="formatNumber(netToLandlord)"></span></h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Properties Management Tab -->
        <div x-show="activeTab === 'properties'" x-cloak>
            <div class="sticky-header p-6 md:p-8 pb-6 mt-12 lg:mt-0">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-slate-800">Properties Management</h2>
                        <p class="text-gray-500 font-medium">Manage all properties and buildings</p>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 md:gap-4">
                        <button x-show="userRole === 'owner'" @click="showAddPropertyModal = true"
                                class="bg-green-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            <span class="hidden md:inline">Add New Property</span>
                        </button>
                        <button @click="exportToPDF('properties')" 
                                class="bg-red-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-bold shadow-lg hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i>
                            <span class="hidden md:inline">Export PDF</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="p-4 md:p-8 pt-6">
                <!-- Properties Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6">
                    <template x-for="(property, name) in properties" :key="name">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden property-card">
                            <div class="p-4 md:p-6">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h4 class="font-bold text-slate-800 text-lg" x-text="name"></h4>
                                        <p class="text-sm text-gray-500" x-text="property.length + ' units'"></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button @click="viewProperty(name)" class="text-blue-600 hover:text-blue-800 p-1">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button x-show="userRole === 'owner'" @click="editProperty(name)" class="text-amber-600 hover:text-amber-800 p-1">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button x-show="userRole === 'owner'" @click="deleteProperty(name)" class="text-red-600 hover:text-red-800 p-1">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-xs text-gray-400 font-medium uppercase">Total Rent</p>
                                        <p class="font-bold text-lg text-slate-800">Ksh <span x-text="formatNumber(calculatePropertyTotal(name, 'rent'))"></span></p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 font-medium uppercase">Occupancy</p>
                                        <div class="flex items-center gap-2">
                                            <div class="w-full bg-gray-200 rounded-full h-2">
                                                <div class="bg-green-500 h-2 rounded-full" 
                                                     :style="{ width: calculateOccupancyRate(name) + '%' }"></div>
                                            </div>
                                            <span class="text-sm font-medium" x-text="calculateOccupancyRate(name) + '%'"></span>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-400 font-medium uppercase">Vacant Units</p>
                                        <p class="font-medium text-red-600" x-text="countVacantUnits(name)"></p>
                                    </div>
                                </div>
                                
                                <button @click="viewProperty(name)" 
                                        class="w-full mt-6 bg-blue-50 text-blue-600 hover:bg-blue-100 py-2 rounded-lg font-medium transition">
                                    Manage Units
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div x-show="activeTab === 'settings'" x-cloak>
            <div class="sticky-header p-6 md:p-8 pb-6 mt-12 lg:mt-0">
                <h2 class="text-2xl md:text-3xl font-black text-slate-800">System Settings</h2>
                <p class="text-gray-500 font-medium">Configure system preferences and settings</p>
            </div>

            <div class="p-4 md:p-8 pt-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    <!-- General Settings -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-6">General Settings</h3>
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Company Name</label>
                                <input type="text" x-model="settings.companyName" 
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Default Water Rate (per m³)</label>
                                <input type="number" x-model="settings.waterRate" 
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Default Penalty (%)</label>
                                <input type="number" x-model="settings.penaltyPercentage" min="0" max="100" step="0.1"
                                       :disabled="userRole !== 'owner'"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"
                                       placeholder="0-100%">
                                <p class="text-xs text-gray-500 mt-1" x-show="userRole !== 'owner'">Only Owner can edit penalty percentage</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Default Garbage Fee</label>
                                <input type="number" x-model="settings.garbageFee" 
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Commission Rate (%)</label>
                                <input type="number" x-model="settings.commissionRate" step="0.01"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <button @click="saveSettings()" 
                                    class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                                Save Settings
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Actions -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 md:p-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-6">System Actions</h3>
                        <div class="space-y-4">
                            <button @click="backupData()" 
                                    class="w-full bg-emerald-50 text-emerald-700 hover:bg-emerald-100 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                                <i class="fas fa-database"></i>
                                Backup All Data
                            </button>
                            
                            <button @click="restoreData()" 
                                    class="w-full bg-amber-50 text-amber-700 hover:bg-amber-100 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                                <i class="fas fa-history"></i>
                                Restore from Backup
                            </button>
                            
                            <button @click="clearAllData()" 
                                    :class="userRole === 'owner' ? 'bg-red-50 text-red-700 hover:bg-red-100' : 'bg-gray-100 text-gray-400 cursor-not-allowed'"
                                    :disabled="userRole !== 'owner'"
                                    class="w-full py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                                <i class="fas fa-trash"></i>
                                Clear All Data
                                <span x-show="userRole !== 'owner'" class="text-xs ml-2">(Owner only)</span>
                            </button>
                            
                            <button @click="rolloverMonth()" 
                                    class="w-full bg-purple-600 text-white hover:bg-purple-700 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2">
                                <i class="fas fa-forward"></i>
                                Rollover to Next Month
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Resolve Payment Modal -->
    <div x-data="{ showResolveModal: false, selectedPayment: {}, resolveHouseId: '' }" x-cloak>
        <div x-show="showResolveModal" 
             class="fixed inset-0 z-[60] overflow-y-auto flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
            
            <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-slate-800 uppercase italic">Assign to House</h3>
                    <button @click="showResolveModal = false" class="text-slate-400 hover:text-red-500 transition">
                        <i class="fas fa-times-circle text-2xl"></i>
                    </button>
                </div>

                <div class="mb-6 p-4 bg-red-50 rounded-2xl border border-red-100">
                    <p class="text-[10px] font-black text-red-400 uppercase">Suspense Reference</p>
                    <p class="font-mono font-bold text-red-700" x-text="selectedPayment.reference"></p>
                    <p class="text-lg font-black text-red-800 mt-1" x-text="formatNumber(selectedPayment.amount)"></p>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Enter Correct House ID</label>
                        <input type="text" x-model="resolveHouseId" placeholder="e.g. EH05" 
                               class="w-full px-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none uppercase font-bold text-lg">
                    </div>

                    <button @click="submitResolution()" 
                            class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase tracking-widest hover:bg-black transition shadow-xl active:scale-95">
                        Confirm & Apply Waterfall
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Refund Modal -->
    <div x-data="{ showRefundModal: false, selectedPayment: {}, refundAmount: 0, refundReason: '' }" x-cloak>
        <div x-show="showRefundModal" 
             class="fixed inset-0 z-[60] overflow-y-auto flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
            
            <div class="bg-white w-full max-w-md rounded-[2.5rem] p-10 shadow-2xl border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-black text-slate-800 uppercase italic">Process Refund</h3>
                    <button @click="showRefundModal = false" class="text-slate-400 hover:text-red-500 transition">
                        <i class="fas fa-times-circle text-2xl"></i>
                    </button>
                </div>

                <div class="mb-6 p-4 bg-purple-50 rounded-2xl border border-purple-100">
                    <p class="text-[10px] font-black text-purple-400 uppercase">Overpayment Details</p>
                    <p class="font-mono font-bold text-purple-700" x-text="selectedPayment.reference"></p>
                    <p class="text-lg font-black text-purple-800 mt-1" x-text="'Max: Ksh ' + formatNumber(selectedPayment.overpayment_balance)"></p>
                </div>

                <div class="space-y-5">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Refund Amount (Ksh)</label>
                        <input type="number" x-model="refundAmount" :max="selectedPayment.overpayment_balance"
                               class="w-full px-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none font-bold text-lg">
                    </div>
                    
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Refund Reason (Required)</label>
                        <input type="text" x-model="refundReason" placeholder="e.g. Duplicate payment, Overpayment refund" 
                               class="w-full px-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none font-bold text-lg">
                    </div>

                    <button @click="processRefundSubmission()" 
                            :disabled="!refundReason || refundAmount <= 0 || refundAmount > selectedPayment.overpayment_balance"
                            :class="!refundReason || refundAmount <= 0 || refundAmount > selectedPayment.overpayment_balance ? 'bg-gray-300 cursor-not-allowed' : 'bg-purple-900 hover:bg-black'"
                            class="w-full text-white py-5 rounded-2xl font-black uppercase tracking-widest transition shadow-xl active:scale-95">
                        Process Refund & Record
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add/Edit Property Modal -->
    <div x-show="showAddPropertyModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-slate-800" x-text="editingProperty ? 'Edit Property' : 'Add New Property'"></h3>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Property Name</label>
                        <input type="text" x-model="newProperty.name" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Address</label>
                        <input type="text" x-model="newProperty.address" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Number of Units</label>
                        <input type="number" x-model="newProperty.units" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Landlord Name / Bank Account</label>
                        <input type="text" x-model="newProperty.landlord" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Notes</label>
                        <textarea x-model="newProperty.notes" rows="3"
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-8">
                    <button @click="saveProperty()" 
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                        Save Property
                    </button>
                    <button @click="showAddPropertyModal = false" 
                            class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Tenant Modal -->
    <div x-show="showAddTenantModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-slate-800" x-text="editingTenant ? 'Edit Tenant' : 'Add New Tenant'"></h3>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Property</label>
                        <select x-model="newTenant.property" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Property</option>
                            <template x-for="(property, name) in properties" :key="name">
                                <option :value="name" x-text="name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Unit Number</label>
                        <input type="text" x-model="newTenant.unit" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tenant Name</label>
                        <input type="text" x-model="newTenant.name" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Phone Number</label>
                        <input type="tel" x-model="newTenant.phone" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Phone Number 2</label>
                        <input type="tel" x-model="newTenant.phone2" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Rent Amount (Ksh)</label>
                        <input type="number" x-model="newTenant.rent" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Deposit (Ksh)</label>
                        <input type="number" x-model="newTenant.deposit" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Entry Date</label>
                        <input type="date" x-model="newTenant.entryDate" 
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Status</label>
                        <select x-model="newTenant.status" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                            <option value="occupied">Occupied</option>
                            <option value="vacant">Vacant</option>
                            <option value="landlord">Landlord Unit</option>
                            <option value="caretaker">Caretaker</option>
                            <option value="store">Store</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Notes</label>
                    <textarea x-model="newTenant.notes" rows="3"
                              class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex gap-3 mt-8">
                    <button @click="saveTenant()" 
                            class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                        Save Tenant
                    </button>
                    <button @click="showAddTenantModal = false" 
                            class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div x-show="showToast" x-transition
         :class="toastType === 'success' ? 'bg-green-500' : 'bg-red-500'"
         class="fixed bottom-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3">
        <i :class="toastType === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
        <span x-text="toastMessage"></span>
    </div>

    <script>
        // Main Management System
        function managementSystem() {
            return {
                activeTab: 'dashboard',
                userRole: 'owner',
                editMode: true,
                isMobileMenuOpen: false,
                selectedBuilding: '',
                statementMonth: new Date().toISOString().slice(0, 7),
                commissionRate: 10,
                
                showAddPropertyModal: false,
                showAddTenantModal: false,
                editingProperty: null,
                editingTenant: null,
                
                newProperty: {
                    name: '',
                    address: '',
                    units: 0,
                    landlord: '',
                    notes: ''
                },
                
                newTenant: {
                    property: '',
                    unit: '',
                    name: '',
                    phone: '',
                    phone2: '',
                    rent: 0,
                    deposit: 0,
                    entryDate: new Date().toISOString().slice(0, 10),
                    status: 'occupied',
                    notes: ''
                },
                
                showToast: false,
                toastMessage: '',
                toastType: 'success',
                
                broadcastMessage: '',
                notifications: [],
                
                properties: {},
                payments: [],
                statementData: [],
                expenses: [],
                settings: {
                    companyName: 'Eagle Homes',
                    waterRate: 100,
                    penaltyPercentage: 5,
                    garbageFee: 200,
                    commissionRate: 10
                },
                
                // Computed Properties
                get currentMonth() {
                    return new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                },
                
                get filteredProperties() {
                    if (!this.selectedBuilding) return this.properties;
                    return { [this.selectedBuilding]: this.properties[this.selectedBuilding] };
                },
                
                get allTenants() {
                    const allTenants = [];
                    Object.entries(this.properties).forEach(([property, units]) => {
                        units.forEach(unit => {
                            allTenants.push({
                                id: `${property}-${unit.unit}`,
                                property: property,
                                unit: unit.unit,
                                name: unit.name,
                                phone: unit.phone,
                                phone2: unit.phone2,
                                rent: unit.rent,
                                deposit: unit.deposit,
                                arrears: unit.arrears || 0,
                                overpayment_balance: unit.overpayment_balance || 0,
                                status: unit.status,
                                entryDate: unit.entryDate,
                                notes: unit.notes,
                                utilities: unit.utilities || { water: 0, garbage: 200, penalty: 0 },
                                paymentHistory: unit.paymentHistory || []
                            });
                        });
                    });
                    return allTenants;
                },
                
                get totalRevenue() {
                    return this.allTenants.reduce((sum, tenant) => sum + (tenant.rent || 0), 0);
                },
                
                get totalDeposits() {
                    return this.allTenants.reduce((sum, tenant) => sum + (tenant.deposit || 0), 0);
                },
                
                get occupancyRate() {
                    if (this.allTenants.length === 0) return 0;
                    const occupied = this.allTenants.filter(t => t.status === 'occupied').length;
                    return Math.round((occupied / this.allTenants.length) * 100);
                },
                
                get totalCollected() {
                    return this.payments.filter(p => p.status === 'Processed').reduce((sum, p) => sum + p.amount, 0);
                },
                
                get totalArrears() {
                    return this.allTenants.reduce((sum, tenant) => sum + (tenant.arrears || 0), 0);
                },
                
                get totalOverpayment() {
                    return this.allTenants.reduce((sum, tenant) => sum + (tenant.overpayment_balance || 0), 0);
                },
                
                get totalRefunds() {
                    return this.payments.filter(p => p.refund_id).reduce((sum, p) => sum + (p.refund_amount || 0), 0);
                },
                
                get totalPending() {
                    return this.allTenants.reduce((sum, tenant) => sum + tenant.rent, 0) - this.totalCollected;
                },
                
                get unidentifiedPayments() {
                    return this.payments.filter(p => p.status === 'Unidentified' || !p.house_id || p.house_id === '???');
                },
                
                get topProperties() {
                    const propertyStats = {};
                    
                    Object.entries(this.properties).forEach(([name, units]) => {
                        const occupied = units.filter(u => u.status === 'occupied').length;
                        const total = units.length;
                        const revenue = units.reduce((sum, u) => sum + (u.rent || 0), 0);
                        const collected = units.reduce((sum, u) => {
                            const tenant = this.allTenants.find(t => t.property === name && t.unit === u.unit);
                            return sum + (tenant ? (tenant.rent - (tenant.arrears || 0)) : 0);
                        }, 0);
                        
                        propertyStats[name] = {
                            name: name,
                            occupancy: total > 0 ? Math.round((occupied / total) * 100) : 0,
                            revenue: revenue,
                            collectionRate: revenue > 0 ? Math.round((collected / revenue) * 100) : 0
                        };
                    });
                    
                    return Object.values(propertyStats)
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, 5);
                },
                
                // Landlord Statement Computed Properties
                get totalRentCollected() {
                    return this.statementData.reduce((sum, tenant) => sum + (Number(tenant.amountPaid) || 0), 0);
                },
                
                get commissionAmount() {
                    return this.totalRentCollected * (this.commissionRate / 100);
                },
                
                get totalExpenses() {
                    return this.expenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
                },
                
                get netToLandlord() {
                    return this.totalRentCollected - this.commissionAmount - this.totalExpenses;
                },
                
                // Initialization
                init() {
                    const savedProperties = localStorage.getItem('eagle_properties');
                    const savedPayments = localStorage.getItem('eagle_payments');
                    const savedSettings = localStorage.getItem('eagle_settings');
                    const savedRole = localStorage.getItem('userRole');
                    const savedStatementData = localStorage.getItem('eagle_statement_data');
                    const savedExpenses = localStorage.getItem('eagle_expenses');
                    const savedNotifications = localStorage.getItem('eagle_notifications');
                    
                    if (savedRole) this.userRole = savedRole;
                    if (savedSettings) this.settings = JSON.parse(savedSettings);
                    if (this.settings.commissionRate) this.commissionRate = this.settings.commissionRate;
                    
                    if (savedProperties) {
                        this.properties = JSON.parse(savedProperties);
                    } else {
                        this.initializeSampleData();
                    }
                    
                    if (savedPayments) {
                        this.payments = JSON.parse(savedPayments);
                    }
                    
                    if (savedStatementData) {
                        this.statementData = JSON.parse(savedStatementData);
                    } else {
                        this.initializeStatementData();
                    }
                    
                    if (savedExpenses) {
                        this.expenses = JSON.parse(savedExpenses);
                    }
                    
                    if (savedNotifications) {
                        this.notifications = JSON.parse(savedNotifications);
                    }
                    
                    // Check for automated notifications
                    this.checkAutomatedNotifications();
                },
                
                initializeSampleData() {
                    this.properties = {
                        "ROSALIA HOUSE": [
                            { 
                                unit: "1", 
                                name: "Paul Murimi", 
                                rent: 3000, 
                                deposit: 3000, 
                                phone: "0712345678", 
                                phone2: "",
                                status: "occupied", 
                                entryDate: "2025-01-01", 
                                notes: "",
                                arrears: 0,
                                overpayment_balance: 0,
                                utilities: { water: 0, garbage: 200, penalty: 0 },
                                paymentHistory: []
                            },
                            { 
                                unit: "2", 
                                name: "Jane Mwangi", 
                                rent: 1500, 
                                deposit: 1500, 
                                phone: "0723456789", 
                                phone2: "",
                                status: "occupied", 
                                entryDate: "2025-01-01", 
                                notes: "",
                                arrears: 500,
                                overpayment_balance: 0,
                                utilities: { water: 100, garbage: 200, penalty: 0 },
                                paymentHistory: []
                            },
                        ]
                    };
                    
                    this.payments = [
                        { 
                            id: 1, 
                            reference: 'UAMKG4',
                            house_id: 'ROSALIA HOUSE-1', 
                            tenant: 'Paul Murimi', 
                            amount: 3000, 
                            method: 'M-Pesa', 
                            status: 'Processed', 
                            date: '2025-01-05',
                            time: '14:30',
                            deductions_json: JSON.stringify({ water: 0, garbage: 200, rent: 2800 }),
                            overpayment_balance: 0
                        },
                        { 
                            id: 2, 
                            reference: 'RXB5T9',
                            house_id: null, 
                            tenant: null, 
                            amount: 2000, 
                            method: 'Co-op Bank', 
                            status: 'Unidentified', 
                            date: '2025-01-06',
                            time: '15:45',
                            deductions_json: '{}',
                            overpayment_balance: 0
                        }
                    ];
                    
                    this.saveData();
                },
                
                initializeStatementData() {
                    this.statementData = [
                        { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" },
                        { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" },
                        { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" }
                    ];
                },
                
                // Notification Functions
                checkAutomatedNotifications() {
                    const today = new Date();
                    const day = today.getDate();
                    const month = today.getMonth() + 1;
                    
                    // Check for arrears reminders on the 5th
                    if (day === 5) {
                        this.sendArrearsReminders();
                    }
                    
                    // Check for holiday messages
                    this.checkHolidayMessages(today);
                },
                
                sendArrearsReminders() {
                    const tenantsWithArrears = this.allTenants.filter(tenant => 
                        (tenant.arrears || 0) > 0 && tenant.phone && tenant.status === 'occupied'
                    );
                    
                    if (tenantsWithArrears.length === 0) {
                        this.showToastMessage('No tenants with arrears to notify', 'success');
                        return;
                    }
                    
                    tenantsWithArrears.forEach(tenant => {
                        const message = `Dear ${tenant.name}, this is a friendly reminder from Eagle Homes – Property Management. Your outstanding balance for ${tenant.property}-${tenant.unit} is Ksh ${this.formatNumber(tenant.arrears)}. Please clear to avoid penalties.`;
                        
                        this.notifications.unshift({
                            id: Date.now(),
                            date: new Date().toLocaleDateString(),
                            type: 'arrears',
                            recipient: `${tenant.name} (${tenant.phone})`,
                            message: message,
                            status: 'sent'
                        });
                    });
                    
                    this.saveNotifications();
                    this.showToastMessage(`Arrears reminders sent to ${tenantsWithArrears.length} tenants`, 'success');
                },
                
                checkHolidayMessages(today) {
                    const holidays = [
                        { month: 10, day: 20, name: 'Mashujaa Day' },
                        { month: 6, day: 1, name: 'Madaraka Day' },
                        { month: 12, day: 25, name: 'Merry Christmas' }
                    ];
                    
                    const holiday = holidays.find(h => h.month === today.getMonth() + 1 && h.day === today.getDate());
                    
                    if (holiday) {
                        this.sendHolidayMessage(holiday.name);
                    }
                },
                
                sendHolidayMessage(holidayName) {
                    const tenantsWithPhone = this.allTenants.filter(tenant => 
                        (tenant.phone || tenant.phone2) && tenant.status === 'occupied'
                    );
                    
                    tenantsWithPhone.forEach(tenant => {
                        const message = `Dear ${tenant.name}, Eagle Homes wishes you a happy ${holidayName}! Thank you for being part of our community.`;
                        
                        this.notifications.unshift({
                            id: Date.now(),
                            date: new Date().toLocaleDateString(),
                            type: 'holiday',
                            recipient: `${tenant.name} (${tenant.phone || tenant.phone2})`,
                            message: message,
                            status: 'sent'
                        });
                    });
                    
                    this.saveNotifications();
                },
                
                sendBroadcastMessage() {
                    if (!this.broadcastMessage.trim()) {
                        this.showToastMessage('Please enter a message', 'error');
                        return;
                    }
                    
                    const tenantsWithPhone = this.allTenants.filter(tenant => 
                        (tenant.phone || tenant.phone2) && tenant.status === 'occupied'
                    );
                    
                    if (tenantsWithPhone.length === 0) {
                        this.showToastMessage('No tenants with phone numbers to notify', 'error');
                        return;
                    }
                    
                    this.notifications.unshift({
                        id: Date.now(),
                        date: new Date().toLocaleDateString(),
                        type: 'broadcast',
                        recipient: 'All Tenants',
                        message: this.broadcastMessage,
                        status: 'sent'
                    });
                    
                    this.saveNotifications();
                    this.broadcastMessage = '';
                    this.showToastMessage(`Broadcast message sent to ${tenantsWithPhone.length} tenants`, 'success');
                },
                
                saveNotifications() {
                    localStorage.setItem('eagle_notifications', JSON.stringify(this.notifications));
                },
                
                // Utility Entry Functions
                saveHouseUtilities(tenantId) {
                    const tenant = this.allTenants.find(t => t.id === tenantId);
                    if (!tenant) return;
                    
                    const waterInput = document.getElementById(`water-${tenantId}`);
                    const penaltyInput = document.getElementById(`penalty-${tenantId}`);
                    
                    const water = parseFloat(waterInput?.value) || 0;
                    const penalty = parseFloat(penaltyInput?.value) || 0;
                    
                    // Update tenant utilities
                    const property = this.properties[tenant.property];
                    const unitIndex = property.findIndex(u => u.unit === tenant.unit);
                    
                    if (unitIndex !== -1) {
                        property[unitIndex].utilities = {
                            water: water,
                            garbage: this.settings.garbageFee || 200,
                            penalty: penalty
                        };
                    }
                    
                    this.saveData();
                    this.showToastMessage(`Utilities updated for ${tenant.name}`, 'success');
                },
                
                // Strict Arrears-First Logic
                applyWaterfallLogic(paymentAmount, tenant) {
                    const deductions = {};
                    let remainingAmount = paymentAmount;
                    
                    // 1. Garbage
                    const garbageAmount = tenant.utilities?.garbage || this.settings.garbageFee || 200;
                    if (garbageAmount > 0 && remainingAmount > 0) {
                        const garbageDeduction = Math.min(garbageAmount, remainingAmount);
                        deductions.garbage = garbageDeduction;
                        remainingAmount -= garbageDeduction;
                    }
                    
                    // 2. Water
                    const waterAmount = tenant.utilities?.water || 0;
                    if (waterAmount > 0 && remainingAmount > 0) {
                        const waterDeduction = Math.min(waterAmount, remainingAmount);
                        deductions.water = waterDeduction;
                        remainingAmount -= waterDeduction;
                    }
                    
                    // 3. Penalty (manually entered only, never automatic)
                    const penaltyAmount = tenant.utilities?.penalty || 0;
                    if (penaltyAmount > 0 && remainingAmount > 0) {
                        const penaltyDeduction = Math.min(penaltyAmount, remainingAmount);
                        deductions.penalty = penaltyDeduction;
                        remainingAmount -= penaltyDeduction;
                    }
                    
                    // 4. Arrears (strict arrears-first logic)
                    const arrearsAmount = tenant.arrears || 0;
                    if (arrearsAmount > 0 && remainingAmount > 0) {
                        const arrearsDeduction = Math.min(arrearsAmount, remainingAmount);
                        deductions.arrears = arrearsDeduction;
                        remainingAmount -= arrearsDeduction;
                    }
                    
                    // 5. Rent (only after all arrears cleared)
                    const rentAmount = tenant.rent || 0;
                    if (remainingAmount > 0) {
                        const rentDeduction = Math.min(rentAmount, remainingAmount);
                        deductions.rent = rentDeduction;
                        remainingAmount -= rentDeduction;
                    }
                    
                    // 6. Overpayment (if still remaining, store but don't auto-apply)
                    if (remainingAmount > 0) {
                        deductions.overpayment = remainingAmount;
                    }
                    
                    return { deductions, remainingAmount };
                },
                
                // Overpayment and duplicate payment handling
                processOverpayment(tenantId, overpaymentAmount) {
                    const tenant = this.allTenants.find(t => t.id === tenantId);
                    if (!tenant) return;
                    
                    const property = this.properties[tenant.property];
                    const unitIndex = property.findIndex(u => u.unit === tenant.unit);
                    
                    if (unitIndex !== -1) {
                        property[unitIndex].overpayment_balance = (property[unitIndex].overpayment_balance || 0) + overpaymentAmount;
                        this.saveData();
                    }
                },
                
                // Refund processing
                processRefund(payment) {
                    // This function is called from payment manager
                    const refundModal = document.querySelector('[x-data*="showRefundModal"]');
                    if (refundModal) {
                        refundModal.__x.$data.selectedPayment = payment;
                        refundModal.__x.$data.refundAmount = Math.min(payment.overpayment_balance, payment.overpayment_balance);
                        refundModal.__x.$data.refundReason = '';
                        refundModal.__x.$data.showRefundModal = true;
                    }
                },
                
                // PDF Export Function
                async exportToPDF(type) {
                    try {
                        this.showToastMessage('Generating PDF...', 'success');
                        
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        // Add header
                        doc.setFontSize(20);
                        doc.setTextColor(30, 64, 175);
                        doc.text('EAGLE HOMES AGENCIES', 105, 20, { align: 'center' });
                        
                        doc.setFontSize(12);
                        doc.setTextColor(107, 114, 128);
                        doc.text('Property Management System', 105, 28, { align: 'center' });
                        
                        // Add title
                        doc.setFontSize(16);
                        doc.setTextColor(0, 0, 0);
                        const titles = {
                            'dashboard': 'Dashboard Summary',
                            'tenants': 'Tenants Report',
                            'properties': 'Properties Report',
                            'statement': 'Landlord Statement',
                            'reports': 'Financial Reports',
                            'utilities': 'Utility Charges',
                            'notifications': 'Notifications Log'
                        };
                        doc.text(titles[type] || 'Report', 105, 40, { align: 'center' });
                        
                        // Add date
                        doc.setFontSize(10);
                        doc.setTextColor(75, 85, 99);
                        const dateStr = new Date().toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        doc.text(`Generated on: ${dateStr}`, 105, 48, { align: 'center' });
                        
                        // Generate content based on type
                        let yPos = 60;
                        
                        switch(type) {
                            case 'dashboard':
                                this.generateDashboardPDF(doc, yPos);
                                break;
                            case 'tenants':
                                this.generateTenantsPDF(doc, yPos);
                                break;
                            case 'properties':
                                this.generatePropertiesPDF(doc, yPos);
                                break;
                            case 'statement':
                                this.generateStatementPDF(doc, yPos);
                                break;
                            case 'reports':
                                this.generateReportsPDF(doc, yPos);
                                break;
                            case 'utilities':
                                this.generateUtilitiesPDF(doc, yPos);
                                break;
                            case 'notifications':
                                this.generateNotificationsPDF(doc, yPos);
                                break;
                        }
                        
                        // Save PDF
                        const fileName = `Eagle_Homes_${titles[type].replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
                        doc.save(fileName);
                        
                        this.showToastMessage('PDF exported successfully!', 'success');
                    } catch (error) {
                        console.error('PDF Generation Error:', error);
                        this.showToastMessage('Failed to generate PDF', 'error');
                    }
                },
                
                generateNotificationsPDF(doc, yPos) {
                    const notificationsData = this.notifications.map(n => [
                        n.date,
                        n.type,
                        n.recipient || 'All',
                        n.message.length > 50 ? n.message.substring(0, 50) + '...' : n.message,
                        n.status
                    ]);
                    
                    doc.autoTable({
                        head: [['Date', 'Type', 'Recipient', 'Message', 'Status']],
                        body: notificationsData,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                        margin: { left: 20, right: 20 },
                        styles: { fontSize: 8 }
                    });
                },
                
                generateDashboardPDF(doc, yPos) {
                    // Stats section
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text('Dashboard Summary', 20, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Total Expected Rent: Ksh ${this.formatNumber(this.totalRevenue)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Total Deposits Held: Ksh ${this.formatNumber(this.totalDeposits)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Occupancy Rate: ${this.occupancyRate}%`, 20, yPos);
                    yPos += 6;
                    doc.text(`Total Properties: ${Object.keys(this.properties).length}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Total Arrears: Ksh ${this.formatNumber(this.totalArrears)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Overpayment Balance: Ksh ${this.formatNumber(this.totalOverpayment)}`, 20, yPos);
                    yPos += 15;
                    
                    // Properties table using autoTable
                    const propertiesData = [];
                    Object.entries(this.properties).forEach(([name, units]) => {
                        const occupied = units.filter(u => u.status === 'occupied').length;
                        const totalRent = units.reduce((sum, u) => sum + (u.rent || 0), 0);
                        const occupancy = units.length > 0 ? Math.round((occupied / units.length) * 100) : 0;
                        
                        propertiesData.push([
                            name,
                            units.length.toString(),
                            `${occupancy}%`,
                            `Ksh ${this.formatNumber(totalRent)}`
                        ]);
                    });
                    
                    doc.autoTable({
                        head: [['Property', 'Units', 'Occupancy', 'Total Rent']],
                        body: propertiesData,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                        margin: { left: 20, right: 20 }
                    });
                },
                
                generateTenantsPDF(doc, yPos) {
                    const tenantsData = this.allTenants.map(tenant => [
                        tenant.property,
                        tenant.unit,
                        tenant.name,
                        tenant.phone || '-',
                        `Ksh ${this.formatNumber(tenant.rent)}`,
                        `Ksh ${this.formatNumber(tenant.deposit)}`,
                        `Ksh ${this.formatNumber(tenant.arrears || 0)}`,
                        `Ksh ${this.formatNumber(tenant.overpayment_balance || 0)}`,
                        this.getStatusText(tenant.status)
                    ]);
                    
                    doc.autoTable({
                        head: [['Property', 'Unit', 'Tenant', 'Phone', 'Rent', 'Deposit', 'Arrears', 'Overpayment', 'Status']],
                        body: tenantsData,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                        margin: { left: 20, right: 20 },
                        styles: { fontSize: 8 }
                    });
                    
                    // Add summary after table
                    const finalY = doc.lastAutoTable.finalY || yPos + 100;
                    doc.setFontSize(10);
                    doc.text(`Total Tenants: ${this.allTenants.length}`, 20, finalY + 10);
                    doc.text(`Total Expected Rent: Ksh ${this.formatNumber(this.totalRevenue)}`, 20, finalY + 16);
                    doc.text(`Total Deposits: Ksh ${this.formatNumber(this.totalDeposits)}`, 20, finalY + 22);
                    doc.text(`Total Arrears: Ksh ${this.formatNumber(this.totalArrears)}`, 20, finalY + 28);
                },
                
                generatePropertiesPDF(doc, yPos) {
                    const propertiesData = [];
                    Object.entries(this.properties).forEach(([name, units]) => {
                        const occupied = units.filter(u => u.status === 'occupied').length;
                        const vacant = units.filter(u => u.status === 'vacant').length;
                        const totalRent = units.reduce((sum, u) => sum + (u.rent || 0), 0);
                        const occupancy = units.length > 0 ? Math.round((occupied / units.length) * 100) : 0;
                        
                        propertiesData.push([
                            name,
                            units.length.toString(),
                            occupied.toString(),
                            vacant.toString(),
                            `${occupancy}%`,
                            `Ksh ${this.formatNumber(totalRent)}`
                        ]);
                    });
                    
                    doc.autoTable({
                        head: [['Property', 'Units', 'Occupied', 'Vacant', 'Occupancy', 'Total Rent']],
                        body: propertiesData,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                        margin: { left: 20, right: 20 }
                    });
                },
                
                generateStatementPDF(doc, yPos) {
                    const statementData = this.statementData.map(tenant => {
                        const balance = (tenant.rent || 0) - (tenant.amountPaid || 0);
                        return [
                            tenant.unit || '-',
                            tenant.name || '-',
                            `Ksh ${this.formatNumber(tenant.rent || 0)}`,
                            `Ksh ${this.formatNumber(tenant.amountPaid || 0)}`,
                            `Ksh ${this.formatNumber(balance)}`,
                            `Ksh ${this.formatNumber(tenant.garbage || 0)}`,
                            tenant.remarks || '-'
                        ];
                    });
                    
                    doc.autoTable({
                        head: [['Unit', 'Tenant', 'Rent', 'Paid', 'Balance', 'Garbage', 'Remarks']],
                        body: statementData,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Add summary
                    const finalY = doc.lastAutoTable.finalY || yPos + 100;
                    doc.setFontSize(10);
                    doc.text(`Total Rent Collected: Ksh ${this.formatNumber(this.totalRentCollected)}`, 20, finalY + 10);
                    doc.text(`Management Commission (${this.commissionRate}%): Ksh ${this.formatNumber(this.commissionAmount)}`, 20, finalY + 16);
                    doc.text(`Total Expenses: Ksh ${this.formatNumber(this.totalExpenses)}`, 20, finalY + 22);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Net Pay to Landlord: Ksh ${this.formatNumber(this.netToLandlord)}`, 20, finalY + 28);
                },
                
                generateReportsPDF(doc, yPos) {
                    doc.setFontSize(12);
                    doc.text('Financial Summary', 20, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Total Revenue: Ksh ${this.formatNumber(this.totalRevenue)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Rent Collected: Ksh ${this.formatNumber(this.totalCollected)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Outstanding Arrears: Ksh ${this.formatNumber(this.totalArrears)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Overpayment Balance: Ksh ${this.formatNumber(this.totalOverpayment)}`, 20, yPos);
                    yPos += 6;
                    doc.text(`Refunds Processed: Ksh ${this.formatNumber(this.totalRefunds)}`, 20, yPos);
                    yPos += 15;
                    
                    // Top properties
                    doc.setFontSize(12);
                    doc.text('Top Performing Properties', 20, yPos);
                    yPos += 10;
                    
                    const topPropertiesData = this.topProperties.map(property => [
                        property.name,
                        `${property.occupancy}%`,
                        `Ksh ${this.formatNumber(property.revenue)}`,
                        `${property.collectionRate}%`
                    ]);
                    
                    doc.autoTable({
                        head: [['Property', 'Occupancy', 'Revenue', 'Collection Rate']],
                        body: topPropertiesData,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                        margin: { left: 20, right: 20 }
                    });
                },
                
                generateUtilitiesPDF(doc, yPos) {
                    const utilitiesData = this.allTenants.map(tenant => {
                        const water = tenant.utilities?.water || 0;
                        const garbage = tenant.utilities?.garbage || this.settings.garbageFee || 200;
                        const penalty = tenant.utilities?.penalty || 0;
                        const total = water + garbage + penalty;
                        
                        return [
                            `${tenant.property}-${tenant.unit}`,
                            tenant.name,
                            `Ksh ${this.formatNumber(water)}`,
                            `Ksh ${this.formatNumber(garbage)}`,
                            `Ksh ${this.formatNumber(penalty)}`,
                            `Ksh ${this.formatNumber(total)}`
                        ];
                    });
                    
                    doc.autoTable({
                        head: [['House', 'Tenant', 'Water', 'Garbage', 'Penalty', 'Total']],
                        body: utilitiesData,
                        startY: yPos,
                        theme: 'grid',
                        headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                        margin: { left: 20, right: 20 }
                    });
                },
                
                // Landlord Statement Functions
                addNewRow() {
                    this.statementData.push({
                        unit: "",
                        name: "",
                        rent: 0,
                        amountPaid: 0,
                        deposit: 0,
                        garbage: 200,
                        other_bills: 0,
                        remarks: ""
                    });
                },

                removeRow(index) {
                    if (confirm("Are you sure you want to remove this row?")) {
                        this.statementData.splice(index, 1);
                    }
                },

                addExpense() {
                    if (!this.editMode) {
                        this.showToastMessage('Please enable edit mode first', 'error');
                        return;
                    }
                    this.expenses.push({
                        description: "",
                        amount: 0
                    });
                },

                removeExpense(index) {
                    this.expenses.splice(index, 1);
                },

                generateStatement() {
                    // Auto-populate statement with tenant data
                    if (this.selectedBuilding && this.properties[this.selectedBuilding]) {
                        const propertyTenants = this.properties[this.selectedBuilding];
                        
                        // Clear existing data
                        this.statementData = [];
                        
                        // Populate with tenants from selected property
                        propertyTenants.forEach(tenant => {
                            this.statementData.push({
                                unit: tenant.unit,
                                name: tenant.name,
                                rent: tenant.rent || 0,
                                amountPaid: 0, // Initialize to 0
                                deposit: tenant.deposit || 0,
                                garbage: 200, // Default garbage fee
                                other_bills: 0,
                                remarks: ""
                            });
                        });
                        
                        this.showToastMessage('Statement generated from property data', 'success');
                    } else {
                        // Add 5 empty rows if no property selected
                        this.statementData = [
                            { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" },
                            { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" },
                            { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" },
                            { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" },
                            { unit: "", name: "", rent: 0, amountPaid: 0, deposit: 0, garbage: 200, other_bills: 0, remarks: "" }
                        ];
                        this.showToastMessage('Empty statement generated', 'success');
                    }
                },

                saveStatement() {
                    // Save statement data
                    localStorage.setItem('eagle_statement_data', JSON.stringify(this.statementData));
                    localStorage.setItem('eagle_expenses', JSON.stringify(this.expenses));
                    
                    // Create statement summary
                    const statementSummary = {
                        month: this.statementMonth,
                        property: this.selectedBuilding,
                        totalRentCollected: this.totalRentCollected,
                        commissionRate: this.commissionRate,
                        commissionAmount: this.commissionAmount,
                        totalExpenses: this.totalExpenses,
                        netToLandlord: this.netToLandlord,
                        timestamp: new Date().toISOString()
                    };
                    
                    localStorage.setItem('eagle_statement_summary', JSON.stringify(statementSummary));
                    
                    this.showToastMessage('Landlord statement saved successfully', 'success');
                },

                // PDF Export for Statement
                exportStatementPDF() {
                    try {
                        this.showToastMessage('Generating PDF...', 'success');
                        
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        // Add header
                        doc.setFontSize(20);
                        doc.setTextColor(30, 64, 175);
                        doc.text('EAGLE HOMES AGENCIES', 105, 20, { align: 'center' });
                        
                        doc.setFontSize(12);
                        doc.setTextColor(107, 114, 128);
                        doc.text('Landlord Remittance Statement', 105, 28, { align: 'center' });
                        
                        // Property and month info
                        doc.setFontSize(10);
                        doc.setTextColor(75, 85, 99);
                        doc.text(`Property: ${this.selectedBuilding || 'All Properties'}`, 20, 40);
                        doc.text(`Month: ${this.statementMonth || 'Not specified'}`, 20, 46);
                        
                        const dateStr = new Date().toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        doc.text(`Generated on: ${dateStr}`, 105, 46, { align: 'center' });
                        
                        let yPos = 55;
                        
                        // Statement Table
                        const statementData = this.statementData.map(tenant => {
                            const balance = (tenant.rent || 0) - (tenant.amountPaid || 0);
                            return [
                                tenant.unit || '-',
                                tenant.name || '-',
                                `Ksh ${this.formatNumber(tenant.rent || 0)}`,
                                `Ksh ${this.formatNumber(tenant.amountPaid || 0)}`,
                                `Ksh ${this.formatNumber(tenant.deposit || 0)}`,
                                `Ksh ${this.formatNumber(tenant.garbage || 0)}`,
                                `Ksh ${this.formatNumber(balance)}`,
                                `Ksh ${this.formatNumber(tenant.other_bills || 0)}`,
                                tenant.remarks || '-'
                            ];
                        });
                        
                        doc.autoTable({
                            head: [['Unit', 'Tenant', 'Rent', 'Paid', 'Deposit', 'Garbage', 'Balance', 'Other', 'Remarks']],
                            body: statementData,
                            startY: yPos,
                            theme: 'grid',
                            headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                            margin: { left: 10, right: 10 },
                            styles: { fontSize: 8 },
                            columnStyles: {
                                2: { cellWidth: 20 },
                                3: { cellWidth: 20 },
                                4: { cellWidth: 20 },
                                5: { cellWidth: 20 },
                                6: { cellWidth: 20 },
                                7: { cellWidth: 20 }
                            }
                        });
                        
                        // Expenses Table
                        const finalY = doc.lastAutoTable.finalY || yPos + 100;
                        yPos = finalY + 10;
                        
                        if (this.expenses.length > 0) {
                            doc.setFontSize(12);
                            doc.text('Operational Expenses', 20, yPos);
                            yPos += 8;
                            
                            const expensesData = this.expenses.map(exp => [
                                exp.description || '-',
                                `Ksh ${this.formatNumber(exp.amount || 0)}`
                            ]);
                            
                            doc.autoTable({
                                head: [['Description', 'Amount']],
                                body: expensesData,
                                startY: yPos,
                                theme: 'grid',
                                headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                                margin: { left: 20, right: 20 }
                            });
                            
                            yPos = doc.lastAutoTable.finalY + 10;
                        }
                        
                        // Summary Section
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('Statement Summary', 20, yPos);
                        yPos += 8;
                        
                        doc.setFontSize(10);
                        doc.text(`Total Rent Collected: Ksh ${this.formatNumber(this.totalRentCollected)}`, 20, yPos);
                        yPos += 6;
                        doc.text(`Management Commission (${this.commissionRate}%): Ksh ${this.formatNumber(this.commissionAmount)}`, 20, yPos);
                        yPos += 6;
                        doc.text(`Total Expenses: Ksh ${this.formatNumber(this.totalExpenses)}`, 20, yPos);
                        yPos += 6;
                        doc.setFont(undefined, 'bold');
                        doc.text(`Net Pay to Landlord: Ksh ${this.formatNumber(this.netToLandlord)}`, 20, yPos);
                        
                        // Add footer
                        doc.setFontSize(8);
                        doc.setTextColor(156, 163, 175);
                        doc.text('Confidential - Eagle Homes Agencies', 105, 285, { align: 'center' });
                        doc.text(`Page 1 of 1`, 105, 290, { align: 'center' });
                        
                        // Save PDF
                        const fileName = `Eagle_Homes_Statement_${this.selectedBuilding || 'All'}_${this.statementMonth || 'Nodate'}_${new Date().toISOString().slice(0, 10)}.pdf`;
                        doc.save(fileName);
                        
                        this.showToastMessage('Statement PDF exported successfully!', 'success');
                    } catch (error) {
                        console.error('PDF Generation Error:', error);
                        this.showToastMessage('Failed to generate PDF', 'error');
                    }
                },
                
                // Property Management Functions
                viewProperty(propertyName) {
                    this.selectedBuilding = propertyName;
                    this.activeTab = 'tenants';
                },
                
                editProperty(propertyName) {
                    this.editingProperty = propertyName;
                    const property = this.properties[propertyName];
                    this.newProperty = {
                        name: propertyName,
                        address: '',
                        units: property.length,
                        landlord: '',
                        notes: ''
                    };
                    this.showAddPropertyModal = true;
                },
                
                deleteProperty(propertyName) {
                    if (confirm(`Are you sure you want to delete ${propertyName}? This will also delete all tenants in this property.`)) {
                        delete this.properties[propertyName];
                        this.saveData();
                        this.showToastMessage('Property deleted successfully', 'success');
                    }
                },
                
                saveProperty() {
                    if (!this.newProperty.name.trim()) {
                        this.showToastMessage('Property name is required', 'error');
                        return;
                    }
                    
                    if (this.editingProperty && this.editingProperty !== this.newProperty.name) {
                        this.properties[this.newProperty.name] = this.properties[this.editingProperty];
                        delete this.properties[this.editingProperty];
                    } else if (!this.properties[this.newProperty.name]) {
                        this.properties[this.newProperty.name] = [];
                    }
                    
                    const currentUnits = this.properties[this.newProperty.name].length;
                    const targetUnits = parseInt(this.newProperty.units) || 0;
                    
                    if (targetUnits > currentUnits) {
                        for (let i = currentUnits + 1; i <= targetUnits; i++) {
                            this.properties[this.newProperty.name].push({
                                unit: i.toString(),
                                name: "Vacant",
                                rent: 0,
                                deposit: 0,
                                status: "vacant",
                                entryDate: "",
                                notes: "",
                                arrears: 0,
                                overpayment_balance: 0,
                                utilities: { water: 0, garbage: this.settings.garbageFee || 200, penalty: 0 },
                                paymentHistory: []
                            });
                        }
                    } else if (targetUnits < currentUnits) {
                        this.properties[this.newProperty.name] = this.properties[this.newProperty.name].slice(0, targetUnits);
                    }
                    
                    this.saveData();
                    this.showAddPropertyModal = false;
                    this.editingProperty = null;
                    this.newProperty = { name: '', address: '', units: 0, landlord: '', notes: '' };
                    this.showToastMessage('Property saved successfully', 'success');
                },
                
                // Tenant Management Functions
                editTenant(tenant) {
                    this.editingTenant = tenant.id;
                    this.newTenant = { ...tenant };
                    this.showAddTenantModal = true;
                },
                
                viewTenantDetails(tenant) {
                    const details = `
Tenant Details:

Name: ${tenant.name}
Property: ${tenant.property}
Unit: ${tenant.unit}
Rent: Ksh ${this.formatNumber(tenant.rent)}
Deposit: Ksh ${this.formatNumber(tenant.deposit)}
Arrears: Ksh ${this.formatNumber(tenant.arrears || 0)}
Overpayment Balance: Ksh ${this.formatNumber(tenant.overpayment_balance || 0)}
Status: ${this.getStatusText(tenant.status)}
Phone: ${tenant.phone || 'N/A'}
Phone 2: ${tenant.phone2 || 'N/A'}
Entry Date: ${tenant.entryDate || 'N/A'}

Utilities:
- Water: Ksh ${this.formatNumber(tenant.utilities?.water || 0)}
- Garbage: Ksh ${this.formatNumber(tenant.utilities?.garbage || 200)}
- Penalty: Ksh ${this.formatNumber(tenant.utilities?.penalty || 0)}
                    `;
                    alert(details);
                },
                
                deleteTenant(tenant) {
                    if (confirm(`Are you sure you want to delete ${tenant.name}?`)) {
                        const property = this.properties[tenant.property];
                        if (property) {
                            const index = property.findIndex(u => u.unit === tenant.unit);
                            if (index !== -1) {
                                property.splice(index, 1);
                                this.saveData();
                                this.showToastMessage('Tenant deleted successfully', 'success');
                            }
                        }
                    }
                },
                
                saveTenant() {
                    if (!this.newTenant.property || !this.newTenant.name.trim()) {
                        this.showToastMessage('Property and tenant name are required', 'error');
                        return;
                    }
                    
                    const property = this.properties[this.newTenant.property];
                    if (!property) {
                        this.showToastMessage('Selected property not found', 'error');
                        return;
                    }
                    
                    const existingIndex = property.findIndex(u => u.unit === this.newTenant.unit);
                    
                    if (existingIndex !== -1) {
                        // Update existing tenant
                        const existing = property[existingIndex];
                        property[existingIndex] = {
                            unit: this.newTenant.unit,
                            name: this.newTenant.name,
                            rent: parseFloat(this.newTenant.rent) || 0,
                            deposit: parseFloat(this.newTenant.deposit) || 0,
                            phone: this.newTenant.phone || '',
                            phone2: this.newTenant.phone2 || '',
                            status: this.newTenant.status,
                            entryDate: this.newTenant.entryDate,
                            notes: this.newTenant.notes || '',
                            arrears: existing.arrears || 0,
                            overpayment_balance: existing.overpayment_balance || 0,
                            utilities: existing.utilities || { water: 0, garbage: this.settings.garbageFee || 200, penalty: 0 },
                            paymentHistory: existing.paymentHistory || []
                        };
                    } else {
                        // Add new tenant
                        property.push({
                            unit: this.newTenant.unit,
                            name: this.newTenant.name,
                            rent: parseFloat(this.newTenant.rent) || 0,
                            deposit: parseFloat(this.newTenant.deposit) || 0,
                            phone: this.newTenant.phone || '',
                            phone2: this.newTenant.phone2 || '',
                            status: this.newTenant.status,
                            entryDate: this.newTenant.entryDate,
                            notes: this.newTenant.notes || '',
                            arrears: 0,
                            overpayment_balance: 0,
                            utilities: { water: 0, garbage: this.settings.garbageFee || 200, penalty: 0 },
                            paymentHistory: []
                        });
                    }
                    
                    this.saveData();
                    this.showAddTenantModal = false;
                    this.editingTenant = null;
                    this.newTenant = {
                        property: '',
                        unit: '',
                        name: '',
                        phone: '',
                        phone2: '',
                        rent: 0,
                        deposit: 0,
                        entryDate: new Date().toISOString().slice(0, 10),
                        status: 'occupied',
                        notes: ''
                    };
                    this.showToastMessage('Tenant saved successfully', 'success');
                },
                
                // System Functions
                toggleEditMode() {
                    if (this.userRole !== 'owner') {
                        this.showToastMessage('Only owners can edit data', 'error');
                        return;
                    }
                    
                    this.editMode = !this.editMode;
                    if (this.editMode) {
                        this.showToastMessage('Edit mode activated', 'success');
                    } else {
                        this.saveAllChanges();
                    }
                },
                
                saveAllChanges() {
                    this.saveData();
                    this.editMode = false;
                    this.showToastMessage('All changes saved successfully', 'success');
                },
                
                rolloverMonth() {
                    if (confirm('Rollover to next month? This will reset monthly utilities and carry forward arrears.')) {
                        Object.values(this.properties).forEach(property => {
                            property.forEach(tenant => {
                                // Reset utilities for new month
                                tenant.utilities = { water: 0, garbage: this.settings.garbageFee || 200, penalty: 0 };
                                // Arrears carry forward automatically via arrears field
                                // Overpayment balance persists
                            });
                        });
                        this.showToastMessage('Month rolled over successfully. Arrears carried forward.', 'success');
                    }
                },
                
                saveSettings() {
                    if (this.userRole !== 'owner' && this.settings.penaltyPercentage !== this.getStoredPenaltyPercentage()) {
                        this.showToastMessage('Only owners can change penalty percentage', 'error');
                        this.settings.penaltyPercentage = this.getStoredPenaltyPercentage();
                        return;
                    }
                    
                    localStorage.setItem('eagle_settings', JSON.stringify(this.settings));
                    this.showToastMessage('Settings saved successfully', 'success');
                },
                
                getStoredPenaltyPercentage() {
                    const savedSettings = localStorage.getItem('eagle_settings');
                    if (savedSettings) {
                        const parsed = JSON.parse(savedSettings);
                        return parsed.penaltyPercentage || 5;
                    }
                    return 5;
                },
                
                backupData() {
                    const backup = {
                        properties: this.properties,
                        payments: this.payments,
                        statementData: this.statementData,
                        expenses: this.expenses,
                        settings: this.settings,
                        notifications: this.notifications,
                        timestamp: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(backup, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `eagle-homes-backup-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    this.showToastMessage('Backup created successfully', 'success');
                },
                
                restoreData() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    
                    input.onchange = e => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            try {
                                const backup = JSON.parse(event.target.result);
                                this.properties = backup.properties || {};
                                this.payments = backup.payments || [];
                                this.statementData = backup.statementData || this.statementData;
                                this.expenses = backup.expenses || [];
                                this.settings = backup.settings || this.settings;
                                this.notifications = backup.notifications || [];
                                
                                this.saveData();
                                localStorage.setItem('eagle_statement_data', JSON.stringify(this.statementData));
                                localStorage.setItem('eagle_expenses', JSON.stringify(this.expenses));
                                localStorage.setItem('eagle_notifications', JSON.stringify(this.notifications));
                                this.showToastMessage('Data restored successfully', 'success');
                                setTimeout(() => location.reload(), 1000);
                            } catch (error) {
                                this.showToastMessage('Failed to restore backup', 'error');
                            }
                        };
                        
                        reader.readAsText(file);
                    };
                    
                    input.click();
                },
                
                clearAllData() {
                    if (this.userRole !== 'owner') {
                        this.showToastMessage('Only owners can clear all data', 'error');
                        return;
                    }
                    
                    if (confirm('WARNING: This will delete ALL data. Are you absolutely sure?')) {
                        localStorage.clear();
                        this.showToastMessage('All data cleared. Refreshing...', 'success');
                        setTimeout(() => location.reload(), 1000);
                    }
                },
                
                // Helper Functions
                calculatePropertyTotal(propertyName, field) {
                    const property = this.properties[propertyName];
                    if (!property) return 0;
                    return property.reduce((sum, unit) => sum + (unit[field] || 0), 0);
                },
                
                calculateOccupancyRate(propertyName) {
                    const property = this.properties[propertyName];
                    if (!property || property.length === 0) return 0;
                    const occupied = property.filter(u => u.status === 'occupied').length;
                    return Math.round((occupied / property.length) * 100);
                },
                
                countVacantUnits(propertyName) {
                    const property = this.properties[propertyName];
                    if (!property) return 0;
                    return property.filter(u => u.status === 'vacant').length;
                },
                
                formatNumber(num) {
                    return new Intl.NumberFormat('en-KE').format(num || 0);
                },
                
                getStatusClass(status) {
                    const classes = {
                        occupied: 'bg-green-100 text-green-800',
                        vacant: 'bg-red-100 text-red-800',
                        landlord: 'bg-purple-100 text-purple-800',
                        caretaker: 'bg-amber-100 text-amber-800',
                        store: 'bg-blue-100 text-blue-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },
                
                getStatusText(status) {
                    const texts = {
                        occupied: 'Occupied',
                        vacant: 'Vacant',
                        landlord: 'Landlord',
                        caretaker: 'Caretaker',
                        store: 'Store'
                    };
                    return texts[status] || status;
                },
                
                // Data Persistence
                saveData() {
                    localStorage.setItem('eagle_properties', JSON.stringify(this.properties));
                    localStorage.setItem('eagle_payments', JSON.stringify(this.payments));
                    localStorage.setItem('eagle_settings', JSON.stringify(this.settings));
                    localStorage.setItem('userRole', this.userRole);
                },
                
                // User Management
                onRoleChange() {
                    localStorage.setItem('userRole', this.userRole);
                    this.showToastMessage(`Switched to ${this.userRole} role`, 'success');
                },
                
                logout() {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('userRole');
                        window.location.href = 'index.html';
                    }
                },
                
                // Toast Notification
                showToastMessage(message, type = 'success') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                }
            };
        }

        // Payment Manager Component
        function paymentManager() {
            return {
                payments: [],
                paymentSearch: '',
                pathFilter: 'all',
                showResolveModal: false,
                selectedPayment: {},
                resolveHouseId: '',
                
                get filteredPayments() {
                    let filtered = this.payments;
                    
                    // Filter by payment method
                    if (this.pathFilter !== 'all') {
                        filtered = filtered.filter(p => p.method === this.pathFilter);
                    }
                    
                    // Filter by search term
                    if (this.paymentSearch.trim() !== '') {
                        const term = this.paymentSearch.toLowerCase();
                        filtered = filtered.filter(p => {
                            return (
                                (p.reference && p.reference.toLowerCase().includes(term)) ||
                                (p.house_id && p.house_id.toLowerCase().includes(term)) ||
                                (p.phone && p.phone.includes(term)) ||
                                (p.status && p.status.toLowerCase().includes(term))
                            );
                        });
                    }
                    
                    return filtered;
                },
                
                filterPayments() {
                    // Triggered by search input
                },
                
                fetchPayments() {
                    const savedPayments = localStorage.getItem('eagle_payments');
                    if (savedPayments) {
                        this.payments = JSON.parse(savedPayments);
                    } else {
                        this.payments = this.getSamplePayments();
                    }
                },
                
                openResolveModal(payment) {
                    this.selectedPayment = payment;
                    this.resolveHouseId = '';
                    this.showResolveModal = true;
                },
                
                submitResolution() {
                    if (!this.resolveHouseId) {
                        alert("Please enter a House ID");
                        return;
                    }
                    
                    // Parse house ID (format: PROPERTY-UNIT)
                    const [property, unit] = this.resolveHouseId.split('-');
                    if (!property || !unit) {
                        alert("Invalid House ID format. Use: PROPERTY-UNIT (e.g. ROSALIA HOUSE-1)");
                        return;
                    }
                    
                    // Find tenant
                    const mainSystem = document.querySelector('[x-data="managementSystem()"]').__x.$data;
                    const tenant = mainSystem.allTenants.find(t => 
                        t.property === property && t.unit === unit
                    );
                    
                    if (!tenant) {
                        alert("Tenant not found for the specified House ID");
                        return;
                    }
                    
                    // Apply waterfall logic
                    const { deductions, remainingAmount } = mainSystem.applyWaterfallLogic(
                        this.selectedPayment.amount, 
                        tenant
                    );
                    
                    // Update payment record
                    const index = this.payments.findIndex(p => p.id === this.selectedPayment.id);
                    if (index !== -1) {
                        this.payments[index].house_id = this.resolveHouseId;
                        this.payments[index].tenant = tenant.name;
                        this.payments[index].status = 'Processed';
                        this.payments[index].deductions_json = JSON.stringify(deductions);
                        
                        if (remainingAmount > 0) {
                            this.payments[index].overpayment_balance = remainingAmount;
                            // Store overpayment in tenant record
                            mainSystem.processOverpayment(tenant.id, remainingAmount);
                        }
                        
                        // Update tenant arrears
                        const arrearsPaid = deductions.arrears || 0;
                        if (arrearsPaid > 0) {
                            const propertyData = mainSystem.properties[tenant.property];
                            const unitIndex = propertyData.findIndex(u => u.unit === tenant.unit);
                            if (unitIndex !== -1) {
                                propertyData[unitIndex].arrears = Math.max(0, (propertyData[unitIndex].arrears || 0) - arrearsPaid);
                            }
                        }
                        
                        // Add to payment history
                        const paymentHistory = {
                            date: new Date().toISOString().slice(0, 10),
                            amount: this.selectedPayment.amount,
                            deductions: deductions,
                            reference: this.selectedPayment.reference
                        };
                        
                        const propertyData = mainSystem.properties[tenant.property];
                        const unitIndex = propertyData.findIndex(u => u.unit === tenant.unit);
                        if (unitIndex !== -1) {
                            if (!propertyData[unitIndex].paymentHistory) {
                                propertyData[unitIndex].paymentHistory = [];
                            }
                            propertyData[unitIndex].paymentHistory.push(paymentHistory);
                        }
                        
                        mainSystem.saveData();
                        localStorage.setItem('eagle_payments', JSON.stringify(this.payments));
                    }
                    
                    this.showResolveModal = false;
                    this.showToastMessage(`Payment resolved for ${this.resolveHouseId}!`, 'success');
                    
                    // Refresh payments
                    this.fetchPayments();
                },
                
                processRefund(payment) {
                    const refundModal = document.querySelector('[x-data*="showRefundModal"]');
                    if (refundModal) {
                        refundModal.__x.$data.selectedPayment = payment;
                        refundModal.__x.$data.refundAmount = Math.min(payment.overpayment_balance, payment.overpayment_balance);
                        refundModal.__x.$data.refundReason = '';
                        refundModal.__x.$data.showRefundModal = true;
                    }
                },
                
                processRefundSubmission() {
                    const refundModal = document.querySelector('[x-data*="showRefundModal"]');
                    if (!refundModal) return;
                    
                    const { selectedPayment, refundAmount, refundReason } = refundModal.__x.$data;
                    
                    if (!refundReason || refundAmount <= 0 || refundAmount > selectedPayment.overpayment_balance) {
                        this.showToastMessage('Invalid refund amount or reason', 'error');
                        return;
                    }
                    
                    // Update payment record
                    const index = this.payments.findIndex(p => p.id === selectedPayment.id);
                    if (index !== -1) {
                        const refundId = 'REF-' + Date.now().toString().slice(-6);
                        this.payments[index].overpayment_balance -= refundAmount;
                        this.payments[index].refund_id = refundId;
                        this.payments[index].refund_amount = refundAmount;
                        this.payments[index].refund_reason = refundReason;
                        this.payments[index].refund_date = new Date().toISOString().slice(0, 10);
                        
                        // Update tenant overpayment balance
                        const mainSystem = document.querySelector('[x-data="managementSystem()"]').__x.$data;
                        const tenantId = this.payments[index].house_id;
                        const tenant = mainSystem.allTenants.find(t => t.id === tenantId);
                        if (tenant) {
                            const property = mainSystem.properties[tenant.property];
                            const unitIndex = property.findIndex(u => u.unit === tenant.unit);
                            if (unitIndex !== -1) {
                                property[unitIndex].overpayment_balance = Math.max(0, (property[unitIndex].overpayment_balance || 0) - refundAmount);
                            }
                        }
                        
                        mainSystem.saveData();
                        localStorage.setItem('eagle_payments', JSON.stringify(this.payments));
                        
                        // Add to notifications
                        mainSystem.notifications.unshift({
                            id: Date.now(),
                            date: new Date().toLocaleDateString(),
                            type: 'refund',
                            recipient: `${tenant?.name || 'Tenant'} (${refundId})`,
                            message: `Refund of Ksh ${this.formatNumber(refundAmount)} processed. Reason: ${refundReason}`,
                            status: 'sent'
                        });
                        mainSystem.saveNotifications();
                    }
                    
                    refundModal.__x.$data.showRefundModal = false;
                    this.showToastMessage(`Refund of Ksh ${this.formatNumber(refundAmount)} processed successfully`, 'success');
                    
                    // Refresh payments
                    this.fetchPayments();
                },
                
                exportPaymentsPDF() {
                    try {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        // Add header
                        doc.setFontSize(20);
                        doc.setTextColor(30, 64, 175);
                        doc.text('EAGLE HOMES AGENCIES', 105, 20, { align: 'center' });
                        
                        doc.setFontSize(12);
                        doc.setTextColor(107, 114, 128);
                        doc.text('Payments Ledger', 105, 28, { align: 'center' });
                        
                        // Add date
                        doc.setFontSize(10);
                        doc.setTextColor(75, 85, 99);
                        const dateStr = new Date().toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });
                        doc.text(`Generated on: ${dateStr}`, 105, 36, { align: 'center' });
                        
                        // Prepare data for table
                        const tableData = this.filteredPayments.map(p => [
                            p.date || '-',
                            p.method || '-',
                            p.reference || '-',
                            p.house_id || '-',
                            `Ksh ${this.formatNumber(p.amount || 0)}`,
                            p.overpayment_balance > 0 ? `Ksh ${this.formatNumber(p.overpayment_balance)}` : '-',
                            p.refund_id || '-',
                            p.status || '-'
                        ]);
                        
                        // Create table
                        doc.autoTable({
                            head: [['Date', 'Method', 'Reference', 'House', 'Amount', 'Overpayment', 'Refund ID', 'Status']],
                            body: tableData,
                            startY: 45,
                            theme: 'grid',
                            headStyles: { fillColor: [243, 244, 246], textColor: [75, 85, 99] },
                            margin: { left: 15, right: 15 },
                            styles: { fontSize: 8 }
                        });
                        
                        // Add summary
                        const finalY = doc.lastAutoTable.finalY || 100;
                        const totalAmount = this.filteredPayments.reduce((sum, p) => sum + (p.amount || 0), 0);
                        const processed = this.filteredPayments.filter(p => p.status === 'Processed').length;
                        const totalOverpayment = this.filteredPayments.reduce((sum, p) => sum + (p.overpayment_balance || 0), 0);
                        const totalRefunds = this.filteredPayments.filter(p => p.refund_id).reduce((sum, p) => sum + (p.refund_amount || 0), 0);
                        
                        doc.setFontSize(10);
                        doc.text(`Total Payments: ${this.filteredPayments.length}`, 20, finalY + 10);
                        doc.text(`Total Amount: Ksh ${this.formatNumber(totalAmount)}`, 20, finalY + 16);
                        doc.text(`Processed: ${processed}`, 20, finalY + 22);
                        doc.text(`Overpayment Balance: Ksh ${this.formatNumber(totalOverpayment)}`, 20, finalY + 28);
                        doc.text(`Refunds Processed: Ksh ${this.formatNumber(totalRefunds)}`, 20, finalY + 34);
                        
                        // Save PDF
                        const fileName = `Eagle_Homes_Payments_${new Date().toISOString().slice(0, 10)}.pdf`;
                        doc.save(fileName);
                        
                        this.showToastMessage('Payments PDF exported successfully!', 'success');
                    } catch (error) {
                        console.error('PDF Export Error:', error);
                        this.showToastMessage('Failed to export PDF', 'error');
                    }
                },
                
                // Helper functions
                formatNumber(num) {
                    return new Intl.NumberFormat('en-KE').format(num || 0);
                },
                
                getPathClass(method) {
                    const classes = {
                        'Family Bank': 'bg-orange-100 text-orange-700 border-orange-300',
                        'Co-op Bank': 'bg-green-100 text-green-700 border-green-300',
                        'Payslip': 'bg-purple-100 text-purple-700 border-purple-300',
                        'M-Pesa': 'bg-emerald-100 text-emerald-700 border-emerald-300',
                        'Cash': 'bg-gray-100 text-gray-700 border-gray-300'
                    };
                    return classes[method] || 'bg-gray-100 text-gray-700 border-gray-300';
                },
                
                // Sample data for testing
                getSamplePayments() {
                    return [
                        {
                            id: 1,
                            reference: 'UAMKG4',
                            house_id: 'ROSALIA HOUSE-1',
                            phone: '0712345678',
                            amount: 3000,
                            method: 'M-Pesa',
                            date: '2025-01-22',
                            time: '14:30',
                            deductions_json: JSON.stringify({ garbage: 200, water: 0, rent: 2800 }),
                            overpayment_balance: 0,
                            status: 'Processed'
                        },
                        {
                            id: 2,
                            reference: 'RXB5T9',
                            house_id: null,
                            phone: '0723456789',
                            amount: 2000,
                            method: 'Co-op Bank',
                            date: '2025-01-22',
                            time: '15:45',
                            deductions_json: '{}',
                            overpayment_balance: 0,
                            status: 'Unidentified'
                        },
                        {
                            id: 3,
                            reference: 'ABC123',
                            house_id: 'ROSALIA HOUSE-2',
                            phone: '0723456789',
                            amount: 1200,
                            method: 'M-Pesa',
                            date: '2025-01-21',
                            time: '10:15',
                            deductions_json: JSON.stringify({ garbage: 200, water: 100, arrears: 500, rent: 400 }),
                            overpayment_balance: 0,
                            status: 'Processed'
                        }
                    ];
                },
                
                // Toast function
                showToastMessage(message, type = 'success') {
                    // Create toast element
                    const toast = document.createElement('div');
                    toast.className = `fixed bottom-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                    toast.innerHTML = `
                        <i class="${type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'}"></i>
                        <span>${message}</span>
                    `;
                    
                    document.body.appendChild(toast);
                    
                    // Remove toast after 3 seconds
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                },
                
                // Initialize
                init() {
                    this.fetchPayments();
                }
            };
        }
        
        // Global function for refund processing
        function processRefundSubmission() {
            const refundModal = document.querySelector('[x-data*="showRefundModal"]');
            if (!refundModal) return;
            
            const paymentManager = document.querySelector('[x-data="paymentManager()"]').__x.$data;
            paymentManager.processRefundSubmission();
        }
    </script>
</body>
</html>
