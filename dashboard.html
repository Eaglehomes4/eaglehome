<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eagle Homes | Property Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
        }
        [x-cloak] { display: none !important; }
        .sidebar-link.active { 
            background-color: #eff6ff; 
            color: #2563eb;
            border-right: 3px solid #2563eb;
        }
        .scrollbar-thin::-webkit-scrollbar { width: 5px; height: 5px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        /* Print styles */
        @media print {
            .no-print, button, .sidebar, header { display: none !important; }
            body { background: white !important; }
            .print-area { border: none !important; box-shadow: none !important; }
        }
        
        /* Table row hover */
        tr:hover { background-color: #f9fafb !important; }
        
        /* Editable field focus */
        .editable:focus {
            background-color: #f0f9ff;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* Loading animation */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body x-data="managementSystem()" x-init="init()" class="min-h-screen bg-gray-50">
    
    <!-- Top Navigation -->
    <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center sticky top-0 z-40 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i class="fas fa-home text-white"></i>
            </div>
            <h1 class="font-bold text-xl text-gray-800">Eagle Homes Property Management</h1>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- Quick Actions -->
            <div class="flex gap-2">
                <button @click="quickSave()" 
                        class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    Quick Save
                </button>
                <button @click="exportCurrentData()" 
                        class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition flex items-center gap-2">
                    <i class="fas fa-download"></i>
                    Export
                </button>
            </div>
            
            <!-- User Info -->
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-blue-600"></i>
                </div>
                <div class="text-sm">
                    <p class="font-medium" x-text="userRole === 'owner' ? 'Owner' : 'Secretary'"></p>
                    <p class="text-gray-500 text-xs">Logged In</p>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 fixed h-full z-30 pt-4 no-print">
        <nav class="p-4 space-y-1">
            <p class="text-xs font-semibold text-gray-400 uppercase px-3 mb-2">Main Menu</p>
            
            <template x-for="item in menuItems" :key="item.id">
                <a href="#" @click.prevent="switchTab(item.id)" 
                   :class="activeTab === item.id ? 'sidebar-link active' : 'text-gray-600 hover:bg-gray-50'"
                   class="flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-medium transition">
                    <i :class="item.icon" class="w-5 h-5"></i>
                    <span x-text="item.name"></span>
                    <span x-show="item.badge" 
                          class="ml-auto bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full"
                          x-text="item.badge"></span>
                </a>
            </template>
            
            <div class="border-t border-gray-200 mt-4 pt-4">
                <div class="px-4 mb-4">
                    <label class="block text-xs font-medium text-gray-500 mb-2">Current Role</label>
                    <select x-model="userRole" @change="saveUserRole()"
                            class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="owner">Owner</option>
                        <option value="secretary">Secretary</option>
                    </select>
                </div>
                
                <div class="px-4">
                    <button @click="logout()" 
                            class="w-full text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="ml-64 pt-4">
        
        <!-- Dashboard -->
        <div x-show="activeTab === 'dashboard'" x-cloak class="p-6">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Dashboard Overview</h2>
                <p class="text-gray-600">Welcome back! Here's your property management summary for <span class="font-semibold" x-text="currentMonth"></span></p>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Total Expected Rent</p>
                            <h3 class="text-2xl font-bold text-gray-800">Ksh <span x-text="formatNumber(totalExpectedRent)"></span></h3>
                        </div>
                        <div class="text-blue-600 text-2xl">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Occupancy Rate</p>
                            <h3 class="text-2xl font-bold text-gray-800" x-text="occupancyRate + '%'"></h3>
                        </div>
                        <div class="text-green-600 text-2xl">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" :style="{ width: occupancyRate + '%' }"></div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Total Properties</p>
                            <h3 class="text-2xl font-bold text-gray-800" x-text="totalProperties"></h3>
                        </div>
                        <div class="text-purple-600 text-2xl">
                            <i class="fas fa-building"></i>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">Total Tenants</p>
                            <h3 class="text-2xl font-bold text-gray-800" x-text="totalTenants"></h3>
                        </div>
                        <div class="text-orange-600 text-2xl">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="bg-white rounded-xl border border-gray-200 p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button @click="switchTab('tenants')" 
                            class="p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user-plus text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Add New Tenant</p>
                                <p class="text-sm text-gray-500">Register a new tenant</p>
                            </div>
                        </div>
                    </button>
                    
                    <button @click="switchTab('utilities')" 
                            class="p-4 border border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 transition text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-bolt text-green-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Enter Utilities</p>
                                <p class="text-sm text-gray-500">Record utility readings</p>
                            </div>
                        </div>
                    </button>
                    
                    <button @click="switchTab('statement')" 
                            class="p-4 border border-gray-200 rounded-lg hover:border-purple-300 hover:bg-purple-50 transition text-left">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-invoice-dollar text-purple-600"></i>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">Landlord Statement</p>
                                <p class="text-sm text-gray-500">Generate monthly statement</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tenants Management -->
        <div x-show="activeTab === 'tenants'" x-cloak class="p-6">
            <div class="mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Tenant Management</h2>
                        <p class="text-gray-600">Manage all tenants across properties</p>
                    </div>
                    <button @click="openAddTenantModal()" 
                            class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fas fa-plus"></i>
                        Add Tenant
                    </button>
                </div>
            </div>
            
            <!-- Filter Bar -->
            <div class="bg-white p-4 rounded-lg border border-gray-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Property</label>
                        <select x-model="filters.property" @change="filterTenants()"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="">All Properties</option>
                            <template x-for="property in propertiesList" :key="property">
                                <option :value="property" x-text="property"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select x-model="filters.status" @change="filterTenants()"
                                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="">All Status</option>
                            <option value="occupied">Occupied</option>
                            <option value="vacant">Vacant</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                        <div class="relative">
                            <input type="text" x-model="filters.search" @input="filterTenants()"
                                   placeholder="Search tenants..."
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 pl-10 text-sm focus:ring-2 focus:ring-blue-500">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <div class="flex items-end">
                        <button @click="clearFilters()" 
                                class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tenants Table -->
            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr class="text-sm text-gray-500 border-b border-gray-200">
                                <th class="px-6 py-3 font-medium text-left">Property</th>
                                <th class="px-6 py-3 font-medium text-left">Unit</th>
                                <th class="px-6 py-3 font-medium text-left">Tenant Name</th>
                                <th class="px-6 py-3 font-medium text-left">Phone</th>
                                <th class="px-6 py-3 font-medium text-left">Rent</th>
                                <th class="px-6 py-3 font-medium text-left">Status</th>
                                <th class="px-6 py-3 font-medium text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="tenant in filteredTenants" :key="tenant.id">
                                <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
                                    <td class="px-6 py-4" x-text="tenant.property"></td>
                                    <td class="px-6 py-4 font-medium" x-text="tenant.unit"></td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-user text-blue-600 text-sm"></i>
                                            </div>
                                            <span x-text="tenant.name"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4" x-text="tenant.phone || '-'"></td>
                                    <td class="px-6 py-4 font-medium" x-text="'Ksh ' + formatNumber(tenant.rent)"></td>
                                    <td class="px-6 py-4">
                                        <span :class="getStatusClass(tenant.status)" 
                                              class="px-2 py-1 rounded text-xs font-medium" 
                                              x-text="getStatusText(tenant.status)"></span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-2">
                                            <button @click="editTenant(tenant)" 
                                                    class="text-blue-600 hover:text-blue-800 p-1"
                                                    title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button x-show="userRole === 'owner'" @click="deleteTenant(tenant)" 
                                                    class="text-red-600 hover:text-red-800 p-1"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            
                            <template x-if="filteredTenants.length === 0">
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center">
                                        <div class="flex flex-col items-center justify-center text-gray-400">
                                            <i class="fas fa-users text-4xl mb-4"></i>
                                            <p class="text-lg font-medium">No tenants found</p>
                                            <p class="text-sm mt-2">Try adjusting your search filters</p>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Utility Entry -->
        <div x-show="activeTab === 'utilities'" x-cloak class="p-6">
            <div class="mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Utility Entry</h2>
                        <p class="text-gray-600">Enter monthly utility readings for properties</p>
                    </div>
                    <button @click="saveUtilities()" 
                            class="bg-green-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save All Readings
                    </button>
                </div>
            </div>
            
            <!-- Property Selection -->
            <div class="bg-white p-5 rounded-lg border border-gray-200 mb-6">
                <div class="flex items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Property</label>
                        <select x-model="selectedProperty" @change="loadPropertyForUtilities()"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            <option value="">Select a property</option>
                            <template x-for="property in propertiesList" :key="property">
                                <option :value="property" x-text="property"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                        <input type="month" x-model="utilityMonth" @change="loadUtilityData()"
                               class="border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>
            
            <!-- Utility Table -->
            <template x-if="selectedProperty">
                <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-200 bg-gray-50">
                        <h3 class="font-semibold text-gray-800" x-text="selectedProperty"></h3>
                        <p class="text-sm text-gray-500" x-text="'Utility readings for ' + utilityMonth"></p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr class="text-sm text-gray-500 border-b border-gray-200">
                                    <th class="px-6 py-3 font-medium text-left">Unit</th>
                                    <th class="px-6 py-3 font-medium text-left">Tenant</th>
                                    <th class="px-6 py-3 font-medium text-left">Water (Ksh)</th>
                                    <th class="px-6 py-3 font-medium text-left">Electricity (Ksh)</th>
                                    <th class="px-6 py-3 font-medium text-left">Garbage (Ksh)</th>
                                    <th class="px-6 py-3 font-medium text-left">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(tenant, index) in utilityTenants" :key="index">
                                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium" x-text="tenant.unit"></td>
                                        <td class="px-6 py-4" x-text="tenant.name"></td>
                                        
                                        <td class="px-6 py-4">
                                            <input type="number" x-model="tenant.water" 
                                                   class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                                                   placeholder="0" min="0">
                                        </td>
                                        
                                        <td class="px-6 py-4">
                                            <input type="number" x-model="tenant.electricity" 
                                                   class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                                                   placeholder="0" min="0">
                                        </td>
                                        
                                        <td class="px-6 py-4">
                                            <input type="number" x-model="tenant.garbage" 
                                                   class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"
                                                   value="200" min="0">
                                        </td>
                                        
                                        <td class="px-6 py-4 font-medium">
                                            Ksh <span x-text="formatNumber(calculateUtilityTotal(tenant))"></span>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-4 border-t border-gray-200 bg-gray-50">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500">Total Utility Bill for <span x-text="selectedProperty"></span></p>
                                <p class="text-xl font-bold text-gray-800">
                                    Ksh <span x-text="formatNumber(calculateTotalUtilityBill())"></span>
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="autoFillZero()" 
                                        class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 transition">
                                    Auto-fill Zeros
                                </button>
                                <button @click="clearAllUtilities()" 
                                        class="px-4 py-2 border border-red-300 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 transition">
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
            
            <template x-if="!selectedProperty">
                <div class="bg-white rounded-lg border border-gray-200 p-12 text-center">
                    <div class="flex flex-col items-center justify-center text-gray-400">
                        <i class="fas fa-bolt text-4xl mb-4"></i>
                        <p class="text-lg font-medium">Select a Property</p>
                        <p class="text-sm mt-2">Choose a property from the dropdown above to enter utility readings</p>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Landlord Statement -->
        <div x-show="activeTab === 'statement'" x-cloak class="p-6">
            <div class="mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Landlord Statement</h2>
                        <p class="text-gray-600">Generate monthly settlement reports for landlords</p>
                    </div>
                    <div class="flex gap-2">
                        <button @click="generateStatement()" 
                                class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition flex items-center gap-2">
                            <i class="fas fa-file-alt"></i>
                            Generate
                        </button>
                        <button @click="printStatement()" 
                                class="bg-gray-800 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-gray-900 transition flex items-center gap-2">
                            <i class="fas fa-print"></i>
                            Print
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Statement Controls -->
            <div class="bg-white p-5 rounded-lg border border-gray-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Property</label>
                        <select x-model="statementProperty" @change="loadStatementData()"
                                class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Property</option>
                            <template x-for="property in propertiesList" :key="property">
                                <option :value="property" x-text="property"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Month</label>
                        <input type="month" x-model="statementMonth" @change="loadStatementData()"
                               class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="md:col-span-2 flex items-end gap-2">
                        <button @click="addExpense()" 
                                class="flex-1 bg-green-50 text-green-700 border border-green-200 px-4 py-2.5 rounded-lg text-sm font-medium hover:bg-green-100 transition flex items-center justify-center gap-2">
                            <i class="fas fa-plus"></i>
                            Add Expense
                        </button>
                        <button @click="editMode = !editMode" 
                                :class="editMode ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'"
                                class="px-4 py-2.5 rounded-lg text-sm font-medium transition">
                            <i :class="editMode ? 'fas fa-save' : 'fas fa-edit'"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Editable Statement -->
            <template x-if="statementProperty">
                <div class="print-area bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <!-- Statement Header -->
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900">Eagle Homes Agencies</h1>
                                <p class="text-gray-600">Landlord Remittance Statement</p>
                                <div class="mt-2 flex gap-4 text-sm">
                                    <span class="font-medium">Property: <span class="text-blue-600" x-text="statementProperty"></span></span>
                                    <span class="font-medium">Month: <span x-text="statementMonthFormatted"></span></span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">Generated on</p>
                                <p class="font-medium" x-text="new Date().toLocaleDateString()"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Statement Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr class="text-sm text-gray-600 border-b border-gray-200">
                                    <th class="px-6 py-3 font-medium text-left">Unit</th>
                                    <th class="px-6 py-3 font-medium text-left">Tenant Name</th>
                                    <th class="px-6 py-3 font-medium text-left">Rent</th>
                                    <th class="px-6 py-3 font-medium text-left">Paid</th>
                                    <th class="px-6 py-3 font-medium text-left">Balance</th>
                                    <th class="px-6 py-3 font-medium text-left">Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="tenant in statementTenants" :key="tenant.unit">
                                    <tr class="border-b border-gray-100">
                                        <td class="px-6 py-4 font-medium" x-text="tenant.unit"></td>
                                        
                                        <td class="px-6 py-4">
                                            <template x-if="editMode">
                                                <input type="text" x-model="tenant.name" 
                                                       class="w-full border border-gray-300 rounded px-2 py-1 text-sm editable">
                                            </template>
                                            <template x-if="!editMode">
                                                <span x-text="tenant.name"></span>
                                            </template>
                                        </td>
                                        
                                        <td class="px-6 py-4">
                                            <template x-if="editMode">
                                                <input type="number" x-model="tenant.rent" 
                                                       class="w-32 border border-gray-300 rounded px-2 py-1 text-sm text-right editable">
                                            </template>
                                            <template x-if="!editMode">
                                                <span class="font-medium" x-text="'Ksh ' + formatNumber(tenant.rent)"></span>
                                            </template>
                                        </td>
                                        
                                        <td class="px-6 py-4">
                                            <template x-if="editMode">
                                                <input type="number" x-model="tenant.paid" 
                                                       class="w-32 border border-blue-200 rounded px-2 py-1 text-sm text-right editable bg-blue-50">
                                            </template>
                                            <template x-if="!editMode">
                                                <span class="font-medium text-blue-600" 
                                                      x-text="'Ksh ' + formatNumber(tenant.paid || 0)"></span>
                                            </template>
                                        </td>
                                        
                                        <td class="px-6 py-4 font-medium" 
                                            :class="(tenant.rent - (tenant.paid || 0)) > 0 ? 'text-red-600' : 'text-green-600'">
                                            Ksh <span x-text="formatNumber(tenant.rent - (tenant.paid || 0))"></span>
                                        </td>
                                        
                                        <td class="px-6 py-4">
                                            <template x-if="editMode">
                                                <input type="text" x-model="tenant.remarks" 
                                                       class="w-full border border-gray-300 rounded px-2 py-1 text-sm editable"
                                                       placeholder="Add remarks...">
                                            </template>
                                            <template x-if="!editMode">
                                                <span class="text-sm text-gray-500" x-text="tenant.remarks || '-'"></span>
                                            </template>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Expenses and Summary -->
                    <div class="p-6 border-t border-gray-200">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <!-- Expenses Section -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Operational Expenses</h3>
                                <div class="space-y-2">
                                    <template x-for="(expense, index) in expenses" :key="index">
                                        <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                                            <div class="flex-1">
                                                <template x-if="editMode">
                                                    <input type="text" x-model="expense.description" 
                                                           class="w-full border border-gray-300 rounded px-2 py-1 text-sm editable">
                                                </template>
                                                <template x-if="!editMode">
                                                    <span x-text="expense.description"></span>
                                                </template>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-red-600 font-medium">
                                                    - Ksh <span x-text="formatNumber(expense.amount)"></span>
                                                </span>
                                                <button x-show="editMode" @click="removeExpense(index)"
                                                        class="text-red-400 hover:text-red-600">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <button @click="addExpense()" 
                                            class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-2">
                                        <i class="fas fa-plus"></i>
                                        Add Expense Item
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Summary Section -->
                            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Settlement Summary</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Collected</span>
                                        <span class="font-medium">Ksh <span x-text="formatNumber(statementSummary.totalCollected)"></span></span>
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Commission (10%)</span>
                                        <span class="font-medium text-red-600">- Ksh <span x-text="formatNumber(statementSummary.commission)"></span></span>
                                    </div>
                                    
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Expenses</span>
                                        <span class="font-medium text-red-600">- Ksh <span x-text="formatNumber(statementSummary.totalExpenses)"></span></span>
                                    </div>
                                    
                                    <div class="pt-3 border-t border-gray-300">
                                        <div class="flex justify-between">
                                            <span class="text-lg font-bold text-gray-900">Net to Landlord</span>
                                            <span class="text-2xl font-bold text-green-600">
                                                Ksh <span x-text="formatNumber(statementSummary.netToLandlord)"></span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        </div>
        
        <!-- Reports -->
        <div x-show="activeTab === 'reports'" x-cloak class="p-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Financial Reports</h2>
                <p class="text-gray-600">Generate and view detailed financial reports</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Report Options -->
                <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Generate Report</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                            <select x-model="reportType" 
                                    class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                                <option value="monthly">Monthly Summary</option>
                                <option value="property">Property Performance</option>
                                <option value="tenant">Tenant Statement</option>
                                <option value="arrears">Arrears Report</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                <input type="month" x-model="reportStartDate"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                <input type="month" x-model="reportEndDate"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <button @click="generateReport()" 
                                    class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                                Generate Report
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Reports -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Reports</h3>
                    <div class="space-y-3">
                        <template x-for="report in recentReports" :key="report.id">
                            <div class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium text-gray-800" x-text="report.type"></p>
                                        <p class="text-sm text-gray-500" x-text="report.date"></p>
                                    </div>
                                    <button @click="downloadReport(report)"
                                            class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings -->
        <div x-show="activeTab === 'settings'" x-cloak class="p-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">System Settings</h2>
                <p class="text-gray-600">Configure system preferences and security</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- General Settings -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">General Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                            <input type="text" x-model="settings.companyName"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Default Garbage Fee</label>
                                <input type="number" x-model="settings.garbageFee"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Commission Rate (%)</label>
                                <input type="number" x-model="settings.commissionRate" step="0.1"
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <button @click="saveSettings()" 
                                    class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                                Save Settings
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Data Management -->
                <div class="bg-white rounded-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Management</h3>
                    
                    <div class="space-y-3">
                        <button @click="backupData()" 
                                class="w-full bg-green-50 text-green-700 border border-green-200 px-4 py-3 rounded-lg font-medium hover:bg-green-100 transition flex items-center justify-center gap-2">
                            <i class="fas fa-database"></i>
                            Backup All Data
                        </button>
                        
                        <button @click="restoreData()" 
                                class="w-full bg-yellow-50 text-yellow-700 border border-yellow-200 px-4 py-3 rounded-lg font-medium hover:bg-yellow-100 transition flex items-center justify-center gap-2">
                            <i class="fas fa-history"></i>
                            Restore from Backup
                        </button>
                        
                        <button x-show="userRole === 'owner'" @click="clearAllData()" 
                                class="w-full bg-red-50 text-red-700 border border-red-200 px-4 py-3 rounded-lg font-medium hover:bg-red-100 transition flex items-center justify-center gap-2">
                            <i class="fas fa-trash"></i>
                            Clear All Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Add/Edit Tenant Modal -->
    <div x-show="showTenantModal" x-cloak 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl w-full max-w-md">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">
                    <span x-text="editingTenant ? 'Edit Tenant' : 'Add New Tenant'"></span>
                </h3>
            </div>
            
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Property</label>
                        <select x-model="currentTenant.property" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Property</option>
                            <template x-for="property in propertiesList" :key="property">
                                <option :value="property" x-text="property"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit Number</label>
                            <input type="text" x-model="currentTenant.unit"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rent (Ksh)</label>
                            <input type="number" x-model="currentTenant.rent"
                                   class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tenant Name</label>
                        <input type="text" x-model="currentTenant.name"
                               class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                        <input type="tel" x-model="currentTenant.phone"
                               class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select x-model="currentTenant.status" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-blue-500">
                            <option value="occupied">Occupied</option>
                            <option value="vacant">Vacant</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-8">
                    <button @click="saveTenant()" 
                            class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                        Save Tenant
                    </button>
                    <button @click="closeTenantModal()" 
                            class="flex-1 bg-gray-100 text-gray-700 px-4 py-3 rounded-lg font-medium hover:bg-gray-200 transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div x-show="showToast" x-transition
         class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3">
        <i :class="toastIcon" class="text-lg"></i>
        <span x-text="toastMessage"></span>
    </div>
    
    <script>
        function managementSystem() {
            return {
                // State
                activeTab: 'dashboard',
                userRole: 'secretary',
                editMode: false,
                
                // Menu Items
                menuItems: [
                    { id: 'dashboard', name: 'Dashboard', icon: 'fas fa-tachometer-alt' },
                    { id: 'tenants', name: 'Tenants', icon: 'fas fa-users' },
                    { id: 'utilities', name: 'Utility Entry', icon: 'fas fa-bolt' },
                    { id: 'statement', name: 'Landlord Statement', icon: 'fas fa-file-invoice-dollar' },
                    { id: 'reports', name: 'Reports', icon: 'fas fa-chart-bar' },
                    { id: 'settings', name: 'Settings', icon: 'fas fa-cog' }
                ],
                
                // Filters
                filters: {
                    property: '',
                    status: '',
                    search: ''
                },
                
                // Properties Data
                properties: {},
                propertiesList: [],
                
                // Tenants
                allTenants: [],
                filteredTenants: [],
                showTenantModal: false,
                editingTenant: null,
                currentTenant: {
                    property: '',
                    unit: '',
                    name: '',
                    phone: '',
                    rent: 0,
                    status: 'occupied'
                },
                
                // Utilities
                selectedProperty: '',
                utilityMonth: new Date().toISOString().slice(0, 7),
                utilityTenants: [],
                
                // Landlord Statement
                statementProperty: '',
                statementMonth: new Date().toISOString().slice(0, 7),
                statementTenants: [],
                expenses: [],
                statementSummary: {
                    totalCollected: 0,
                    commission: 0,
                    totalExpenses: 0,
                    netToLandlord: 0
                },
                
                // Reports
                reportType: 'monthly',
                reportStartDate: new Date().toISOString().slice(0, 7),
                reportEndDate: new Date().toISOString().slice(0, 7),
                recentReports: [],
                
                // Settings
                settings: {
                    companyName: 'Eagle Homes Agencies',
                    garbageFee: 200,
                    commissionRate: 10
                },
                
                // Toast
                showToast: false,
                toastMessage: '',
                toastIcon: '',
                
                // Computed Properties
                get currentMonth() {
                    return new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                },
                
                get statementMonthFormatted() {
                    if (!this.statementMonth) return '';
                    const [year, month] = this.statementMonth.split('-');
                    return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                },
                
                get totalExpectedRent() {
                    return this.allTenants.reduce((sum, tenant) => sum + (tenant.rent || 0), 0);
                },
                
                get occupancyRate() {
                    if (this.allTenants.length === 0) return 0;
                    const occupied = this.allTenants.filter(t => t.status === 'occupied').length;
                    return Math.round((occupied / this.allTenants.length) * 100);
                },
                
                get totalProperties() {
                    return this.propertiesList.length;
                },
                
                get totalTenants() {
                    return this.allTenants.length;
                },
                
                // Initialization
                init() {
                    this.loadFromLocalStorage();
                    this.filterTenants();
                    this.updateMenuBadges();
                    
                    // Auto-save every 30 seconds
                    setInterval(() => {
                        this.autoSave();
                    }, 30000);
                },
                
                // Navigation
                switchTab(tab) {
                    this.activeTab = tab;
                    if (tab === 'utilities' && !this.selectedProperty && this.propertiesList.length > 0) {
                        this.selectedProperty = this.propertiesList[0];
                        this.loadPropertyForUtilities();
                    }
                    if (tab === 'statement' && !this.statementProperty && this.propertiesList.length > 0) {
                        this.statementProperty = this.propertiesList[0];
                        this.loadStatementData();
                    }
                },
                
                // Data Loading
                loadFromLocalStorage() {
                    const savedProperties = localStorage.getItem('eagle_properties');
                    const savedTenants = localStorage.getItem('eagle_tenants');
                    const savedSettings = localStorage.getItem('eagle_settings');
                    const savedExpenses = localStorage.getItem('eagle_expenses');
                    const savedRole = localStorage.getItem('eagle_userRole');
                    
                    if (savedRole) this.userRole = savedRole;
                    if (savedSettings) this.settings = JSON.parse(savedSettings);
                    if (savedExpenses) this.expenses = JSON.parse(savedExpenses);
                    
                    if (savedProperties) {
                        this.properties = JSON.parse(savedProperties);
                        this.propertiesList = Object.keys(this.properties);
                    } else {
                        this.initializeSampleData();
                    }
                    
                    if (savedTenants) {
                        this.allTenants = JSON.parse(savedTenants);
                    } else {
                        this.extractTenantsFromProperties();
                    }
                },
                
                initializeSampleData() {
                    this.properties = {
                        "ROSALIA HOUSE": [
                            { unit: "1", name: "Paul Murimi", rent: 3000, phone: "0712345678", status: "occupied" },
                            { unit: "2", name: "Jane Mwangi", rent: 1500, phone: "0723456789", status: "occupied" },
                            { unit: "3", name: "John Kamau", rent: 3000, phone: "0734567890", status: "occupied" }
                        ],
                        "JOSPHINE NJAMBI": [
                            { unit: "1", name: "Simon Ndungu", rent: 4150, phone: "0745678901", status: "occupied" },
                            { unit: "2", name: "Irene Gichuki", rent: 3650, phone: "0756789012", status: "occupied" }
                        ]
                    };
                    
                    this.propertiesList = Object.keys(this.properties);
                    this.extractTenantsFromProperties();
                    this.saveAllData();
                },
                
                extractTenantsFromProperties() {
                    this.allTenants = [];
                    Object.entries(this.properties).forEach(([property, units]) => {
                        units.forEach(unit => {
                            this.allTenants.push({
                                id: `${property}-${unit.unit}`,
                                property: property,
                                unit: unit.unit,
                                name: unit.name,
                                phone: unit.phone,
                                rent: unit.rent,
                                status: unit.status
                            });
                        });
                    });
                },
                
                // Tenant Management
                filterTenants() {
                    let filtered = [...this.allTenants];
                    
                    if (this.filters.property) {
                        filtered = filtered.filter(t => t.property === this.filters.property);
                    }
                    
                    if (this.filters.status) {
                        filtered = filtered.filter(t => t.status === this.filters.status);
                    }
                    
                    if (this.filters.search) {
                        const query = this.filters.search.toLowerCase();
                        filtered = filtered.filter(t => 
                            t.name.toLowerCase().includes(query) ||
                            t.unit.toLowerCase().includes(query) ||
                            t.property.toLowerCase().includes(query) ||
                            (t.phone && t.phone.toLowerCase().includes(query))
                        );
                    }
                    
                    this.filteredTenants = filtered;
                },
                
                clearFilters() {
                    this.filters.property = '';
                    this.filters.status = '';
                    this.filters.search = '';
                    this.filterTenants();
                },
                
                openAddTenantModal(tenant = null) {
                    this.editingTenant = tenant;
                    if (tenant) {
                        this.currentTenant = { ...tenant };
                    } else {
                        this.currentTenant = {
                            property: this.propertiesList.length > 0 ? this.propertiesList[0] : '',
                            unit: '',
                            name: '',
                            phone: '',
                            rent: 0,
                            status: 'occupied'
                        };
                    }
                    this.showTenantModal = true;
                },
                
                closeTenantModal() {
                    this.showTenantModal = false;
                    this.editingTenant = null;
                    this.currentTenant = {
                        property: '',
                        unit: '',
                        name: '',
                        phone: '',
                        rent: 0,
                        status: 'occupied'
                    };
                },
                
                editTenant(tenant) {
                    this.openAddTenantModal(tenant);
                },
                
                saveTenant() {
                    if (!this.currentTenant.property || !this.currentTenant.unit || !this.currentTenant.name) {
                        this.showToastMessage('Please fill in all required fields', 'error');
                        return;
                    }
                    
                    // Update properties data
                    if (!this.properties[this.currentTenant.property]) {
                        this.properties[this.currentTenant.property] = [];
                        this.propertiesList = Object.keys(this.properties);
                    }
                    
                    const propertyUnits = this.properties[this.currentTenant.property];
                    const existingIndex = propertyUnits.findIndex(u => u.unit === this.currentTenant.unit);
                    
                    const tenantData = {
                        unit: this.currentTenant.unit,
                        name: this.currentTenant.name,
                        phone: this.currentTenant.phone,
                        rent: parseFloat(this.currentTenant.rent) || 0,
                        status: this.currentTenant.status
                    };
                    
                    if (existingIndex !== -1) {
                        propertyUnits[existingIndex] = tenantData;
                    } else {
                        propertyUnits.push(tenantData);
                    }
                    
                    // Update tenants list
                    this.extractTenantsFromProperties();
                    this.filterTenants();
                    this.saveAllData();
                    
                    this.closeTenantModal();
                    this.showToastMessage(
                        this.editingTenant ? 'Tenant updated successfully' : 'Tenant added successfully',
                        'success'
                    );
                },
                
                deleteTenant(tenant) {
                    if (!confirm(`Are you sure you want to delete ${tenant.name}?`)) return;
                    
                    const propertyUnits = this.properties[tenant.property];
                    if (propertyUnits) {
                        const index = propertyUnits.findIndex(u => u.unit === tenant.unit);
                        if (index !== -1) {
                            propertyUnits.splice(index, 1);
                            this.extractTenantsFromProperties();
                            this.filterTenants();
                            this.saveAllData();
                            this.showToastMessage('Tenant deleted successfully', 'success');
                        }
                    }
                },
                
                // Utility Management
                loadPropertyForUtilities() {
                    if (!this.selectedProperty) return;
                    
                    const property = this.properties[this.selectedProperty];
                    if (!property) return;
                    
                    this.utilityTenants = property.map(tenant => ({
                        ...tenant,
                        water: '',
                        electricity: '',
                        garbage: this.settings.garbageFee || 200
                    }));
                },
                
                loadUtilityData() {
                    // In a real app, this would load saved utility data for the selected month
                    // For now, just reload the property data
                    this.loadPropertyForUtilities();
                },
                
                calculateUtilityTotal(tenant) {
                    const water = parseFloat(tenant.water) || 0;
                    const electricity = parseFloat(tenant.electricity) || 0;
                    const garbage = parseFloat(tenant.garbage) || 0;
                    return water + electricity + garbage;
                },
                
                calculateTotalUtilityBill() {
                    return this.utilityTenants.reduce((sum, tenant) => {
                        return sum + this.calculateUtilityTotal(tenant);
                    }, 0);
                },
                
                autoFillZero() {
                    this.utilityTenants.forEach(tenant => {
                        if (!tenant.water) tenant.water = 0;
                        if (!tenant.electricity) tenant.electricity = 0;
                    });
                    this.showToastMessage('Zero values auto-filled', 'success');
                },
                
                clearAllUtilities() {
                    if (!confirm('Clear all utility readings?')) return;
                    
                    this.utilityTenants.forEach(tenant => {
                        tenant.water = '';
                        tenant.electricity = '';
                    });
                    this.showToastMessage('All readings cleared', 'success');
                },
                
                saveUtilities() {
                    if (!this.selectedProperty) {
                        this.showToastMessage('Please select a property first', 'error');
                        return;
                    }
                    
                    // Save utility data (in a real app, this would save to a separate utility history)
                    this.showToastMessage('Utility readings saved successfully', 'success');
                    
                    // Update the tenants with utility data for statement generation
                    this.properties[this.selectedProperty] = this.properties[this.selectedProperty].map(propertyTenant => {
                        const utilityTenant = this.utilityTenants.find(u => u.unit === propertyTenant.unit);
                        if (utilityTenant) {
                            return {
                                ...propertyTenant,
                                water: utilityTenant.water,
                                electricity: utilityTenant.electricity,
                                garbage: utilityTenant.garbage
                            };
                        }
                        return propertyTenant;
                    });
                    
                    this.saveAllData();
                },
                
                // Landlord Statement
                loadStatementData() {
                    if (!this.statementProperty) {
                        this.statementTenants = [];
                        return;
                    }
                    
                    const property = this.properties[this.statementProperty];
                    if (!property) return;
                    
                    this.statementTenants = property.map(tenant => ({
                        ...tenant,
                        paid: tenant.paid || 0,
                        remarks: tenant.remarks || ''
                    }));
                    
                    this.calculateStatementSummary();
                },
                
                calculateStatementSummary() {
                    const totalCollected = this.statementTenants.reduce((sum, tenant) => {
                        return sum + (parseFloat(tenant.paid) || 0);
                    }, 0);
                    
                    const commission = totalCollected * (this.settings.commissionRate / 100);
                    const totalExpenses = this.expenses.reduce((sum, expense) => {
                        return sum + (parseFloat(expense.amount) || 0);
                    }, 0);
                    
                    this.statementSummary = {
                        totalCollected: totalCollected,
                        commission: commission,
                        totalExpenses: totalExpenses,
                        netToLandlord: totalCollected - commission - totalExpenses
                    };
                },
                
                addExpense() {
                    this.expenses.push({
                        description: 'New Expense',
                        amount: 0
                    });
                    this.calculateStatementSummary();
                },
                
                removeExpense(index) {
                    this.expenses.splice(index, 1);
                    this.calculateStatementSummary();
                },
                
                generateStatement() {
                    if (!this.statementProperty) {
                        this.showToastMessage('Please select a property first', 'error');
                        return;
                    }
                    
                    // Update property data with any changes made in statement
                    if (this.editMode) {
                        this.properties[this.statementProperty] = this.statementTenants.map(tenant => ({
                            unit: tenant.unit,
                            name: tenant.name,
                            phone: tenant.phone,
                            rent: parseFloat(tenant.rent) || 0,
                            status: tenant.status,
                            paid: parseFloat(tenant.paid) || 0,
                            remarks: tenant.remarks || ''
                        }));
                        
                        this.saveAllData();
                        this.editMode = false;
                    }
                    
                    this.calculateStatementSummary();
                    this.showToastMessage('Statement generated successfully', 'success');
                },
                
                printStatement() {
                    window.print();
                },
                
                // Reports
                generateReport() {
                    const report = {
                        id: Date.now(),
                        type: this.reportType,
                        date: new Date().toLocaleDateString(),
                        startDate: this.reportStartDate,
                        endDate: this.reportEndDate
                    };
                    
                    this.recentReports.unshift(report);
                    if (this.recentReports.length > 5) {
                        this.recentReports = this.recentReports.slice(0, 5);
                    }
                    
                    this.showToastMessage('Report generated successfully', 'success');
                },
                
                downloadReport(report) {
                    const dataStr = JSON.stringify(report, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `report-${report.type}-${report.date}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                },
                
                // Settings
                saveSettings() {
                    localStorage.setItem('eagle_settings', JSON.stringify(this.settings));
                    this.showToastMessage('Settings saved successfully', 'success');
                },
                
                // Data Management
                saveAllData() {
                    localStorage.setItem('eagle_properties', JSON.stringify(this.properties));
                    localStorage.setItem('eagle_tenants', JSON.stringify(this.allTenants));
                    localStorage.setItem('eagle_expenses', JSON.stringify(this.expenses));
                    this.updateMenuBadges();
                },
                
                saveUserRole() {
                    localStorage.setItem('eagle_userRole', this.userRole);
                },
                
                quickSave() {
                    this.saveAllData();
                    this.showToastMessage('All data saved', 'success');
                },
                
                autoSave() {
                    this.saveAllData();
                    console.log('Auto-saved at', new Date().toLocaleTimeString());
                },
                
                exportCurrentData() {
                    const data = {
                        properties: this.properties,
                        tenants: this.allTenants,
                        expenses: this.expenses,
                        settings: this.settings,
                        timestamp: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `eagle-homes-backup-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    this.showToastMessage('Data exported successfully', 'success');
                },
                
                backupData() {
                    this.exportCurrentData();
                },
                
                restoreData() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    
                    input.onchange = e => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = (event) => {
                            try {
                                const backup = JSON.parse(event.target.result);
                                this.properties = backup.properties || {};
                                this.propertiesList = Object.keys(this.properties);
                                this.extractTenantsFromProperties();
                                this.expenses = backup.expenses || [];
                                this.settings = backup.settings || this.settings;
                                this.filterTenants();
                                
                                this.saveAllData();
                                this.showToastMessage('Data restored successfully', 'success');
                            } catch (error) {
                                this.showToastMessage('Failed to restore backup', 'error');
                            }
                        };
                        
                        reader.readAsText(file);
                    };
                    
                    input.click();
                },
                
                clearAllData() {
                    if (!confirm('WARNING: This will delete ALL data. Are you sure?')) return;
                    
                    localStorage.clear();
                    this.properties = {};
                    this.propertiesList = [];
                    this.allTenants = [];
                    this.filteredTenants = [];
                    this.expenses = [];
                    this.settings = {
                        companyName: 'Eagle Homes Agencies',
                        garbageFee: 200,
                        commissionRate: 10
                    };
                    
                    this.showToastMessage('All data cleared', 'success');
                },
                
                updateMenuBadges() {
                    // Update menu badges based on data
                    const pendingTenants = this.allTenants.filter(t => t.status === 'vacant').length;
                    this.menuItems.forEach(item => {
                        if (item.id === 'tenants') {
                            item.badge = pendingTenants > 0 ? pendingTenants : null;
                        }
                    });
                },
                
                // Helper Functions
                formatNumber(num) {
                    return new Intl.NumberFormat('en-KE').format(num);
                },
                
                getStatusClass(status) {
                    return status === 'occupied' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                },
                
                getStatusText(status) {
                    return status === 'occupied' ? 'Occupied' : 'Vacant';
                },
                
                showToastMessage(message, type = 'success') {
                    this.toastMessage = message;
                    this.toastIcon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
                    this.showToast = true;
                    
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },
                
                logout() {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('eagle_userRole');
                        // Redirect to login page
                        window.location.href = 'index.html';
                    }
                }
            };
        }
    </script>
</body>
</html>
