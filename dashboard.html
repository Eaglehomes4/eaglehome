<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eagle Homes | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            overflow-x: hidden;
        }
        [x-cloak] { display: none !important; }
        .sidebar-link.active { 
            background-color: #eff6ff; 
            color: #2563eb; 
            border-right: 4px solid #2563eb; 
        }
        .sticky-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            border-bottom: 1px solid #e5e7eb;
        }
        input:focus, select:focus, button:focus {
            outline: none;
            ring: 2px solid #3b82f6;
        }
        .status-vacant { color: #ef4444; }
        .status-occupied { color: #10b981; }
        .status-landlord { color: #8b5cf6; }
        .status-staff { color: #f59e0b; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body x-data="managementSystem()" x-init="init()" class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col fixed h-full z-20">
        <div class="p-6 border-b border-gray-100 flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i class="fas fa-home text-white text-lg"></i>
            </div>
            <h1 class="font-black text-xl tracking-tighter text-slate-800 uppercase">Eagle Homes</h1>
        </div>

        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-4 mb-2">Main Menu</p>
            <a href="#" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-tachometer-alt w-5 h-5"></i>
                Command Center
            </a>
            <a href="#" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-bolt w-5 h-5"></i>
                Utility Entry
            </a>

            <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-4 mt-8 mb-2">Administration</p>
            <a href="#" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-50 rounded-xl text-sm font-semibold transition">
                <i class="fas fa-chart-bar w-5 h-5"></i>
                Financial Reports
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100 space-y-3">
            <!-- User Role Selector -->
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Current Role</label>
                <select x-model="userRole" @change="onRoleChange()"
                        class="w-full bg-gray-50 border border-gray-200 p-2 rounded-lg text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="owner">Owner</option>
                    <option value="secretary">Secretary</option>
                </select>
                <p class="text-xs text-gray-500 mt-1" x-text="userRole === 'owner' ? 'You have full edit permissions' : 'Read-only mode'"></p>
            </div>
            
            <div class="flex items-center gap-3 px-2">
                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-blue-600 text-sm"></i>
                </div>
                <div>
                    <p class="text-sm font-bold text-gray-700" x-text="userRole === 'owner' ? 'Owner' : 'Secretary'"></p>
                    <p class="text-xs text-gray-500">Logged In</p>
                </div>
            </div>
            <button @click="logout()" class="w-full text-red-500 font-bold text-sm py-2 hover:bg-red-50 rounded-lg transition flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="ml-64 flex-1 min-h-screen">
        <div class="sticky-header p-8 pb-6">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-3xl font-black text-slate-800">Command Center</h2>
                    <p class="text-gray-500 font-medium">Eagle Homes Portfolio â€¢ <span class="text-blue-600 font-bold">January 2026</span></p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Owner-only Edit Ledger Button -->
                    <button x-show="userRole === 'owner'" 
                            @click="toggleEditMode()"
                            :class="editMode ? 'bg-amber-500 hover:bg-amber-600' : 'bg-blue-600 hover:bg-blue-700'"
                            class="text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                        <i :class="editMode ? 'fas fa-save' : 'fas fa-edit'"></i>
                        <span x-text="editMode ? 'Save All Changes' : 'Edit Ledger'"></span>
                    </button>
                    
                    <button @click="exportData()" class="bg-gray-100 text-gray-700 px-5 py-2.5 rounded-xl font-semibold hover:bg-gray-200 transition flex items-center gap-2">
                        <i class="fas fa-download"></i>
                        Export Data
                    </button>
                    
                    <button class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fas fa-lock"></i>
                        Lock Month Data
                    </button>
                </div>
            </div>
        </div>

        <div class="p-8 pt-6">
            <!-- Stats Dashboard -->
            <section x-show="userRole === 'owner'" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Total Expected Rent</p>
                            <h3 class="text-2xl font-black text-slate-800">Ksh <span x-text="formatNumber(getStats().totalRent)"></span></h3>
                        </div>
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-money-bill-wave text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-3">Monthly expected revenue from all properties</p>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Total Deposits Held</p>
                            <h3 class="text-2xl font-black text-emerald-600">Ksh <span x-text="formatNumber(getStats().totalDeposits)"></span></h3>
                        </div>
                        <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-shield-alt text-emerald-600 text-xl"></i>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mt-3">Security deposits from tenants</p>
                </div>
                
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Occupancy Rate</p>
                            <h3 class="text-2xl font-black text-purple-600"><span x-text="getStats().occupancy"></span>%</h3>
                        </div>
                        <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                        <div class="bg-purple-600 h-2.5 rounded-full" :style="{ width: getStats().occupancy + '%' }"></div>
                    </div>
                </div>
            </section>

            <!-- Control Panel -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-widest">
                            <i class="fas fa-building mr-2"></i>Viewing Building
                        </label>
                        <select x-model="selectedBuilding" 
                                class="w-full bg-gray-50 border border-gray-200 p-3 rounded-xl font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition">
                            <template x-for="(building, name) in propertyData" :key="name">
                                <option :value="name" x-text="name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2 tracking-widest">
                            <i class="fas fa-search mr-2"></i>Search Tenants
                        </label>
                        <div class="relative">
                            <input type="text" x-model="searchQuery" placeholder="Search by name, unit, or phone..." 
                                   class="w-full bg-gray-50 border border-gray-200 p-3 pl-10 rounded-xl font-medium outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                    
                    <!-- Add New Tenant Button (Owner-only, Edit Mode only) -->
                    <div class="flex items-end gap-3">
                        <div x-show="userRole === 'owner' && editMode" class="flex-1">
                            <button @click="addNewTenant()"
                                    class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition shadow-lg">
                                <i class="fas fa-plus"></i>
                                <span>Add New Tenant</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Status Legend -->
                <div class="mt-4 flex flex-wrap gap-4">
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 bg-emerald-500 rounded-full"></span>
                        <span class="text-gray-600">Occupied</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                        <span class="text-gray-600">Vacant</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 bg-purple-500 rounded-full"></span>
                        <span class="text-gray-600">Landlord Unit</span>
                    </div>
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 bg-amber-500 rounded-full"></span>
                        <span class="text-gray-600">Staff Unit</span>
                    </div>
                </div>
                
                <!-- Edit Mode Indicator -->
                <div x-show="editMode" class="mt-4">
                    <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 flex items-center gap-3">
                        <i class="fas fa-exclamation-triangle text-amber-500"></i>
                        <div>
                            <p class="font-bold text-amber-800">Edit Mode Active</p>
                            <p class="text-sm text-amber-700">You are editing tenant data. Remember to save your changes.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tenants Table -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto scrollbar-hide">
                    <table class="w-full text-left min-w-[1200px]">
                        <thead class="sticky-header">
                            <tr class="text-xs text-gray-400 uppercase tracking-widest border-b border-gray-100 bg-gray-50">
                                <th class="px-6 py-4 font-bold">Unit</th>
                                <th class="px-6 py-4 font-bold">Tenant Name</th>
                                <th class="px-6 py-4 font-bold">Phone</th>
                                <th class="px-6 py-4 font-bold">Rent (Ksh)</th>
                                <th class="px-6 py-4 font-bold">Deposit</th>
                                <th class="px-6 py-4 font-bold">Entry Date</th>
                                <th class="px-6 py-4 font-bold">Exit Date</th>
                                <th class="px-6 py-4 font-bold">Status/Notes</th>
                                <th class="px-6 py-4 font-bold" x-show="userRole === 'owner' && editMode">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                            <template x-for="(tenant, index) in filteredTenants" :key="index">
                                <tr class="hover:bg-blue-50/30 transition group" 
                                    :class="{
                                        'bg-red-50/30': tenant.name.toLowerCase().includes('vacant'),
                                        'bg-purple-50/30': tenant.exitReason && tenant.exitReason.includes('Landlord'),
                                        'bg-amber-50/30': tenant.exitReason && tenant.exitReason.includes('Staff')
                                    }">
                                    <!-- Unit Number -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <input type="text" x-model="tenant.no" 
                                                   class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition font-bold">
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <span class="font-bold text-blue-600" x-text="tenant.no"></span>
                                        </template>
                                    </td>
                                    
                                    <!-- Tenant Name -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <input type="text" x-model="tenant.name" 
                                                   class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-user text-gray-400"></i>
                                                <span x-text="tenant.name" 
                                                      :class="{
                                                        'text-red-500 italic': tenant.name.toLowerCase().includes('vacant'),
                                                        'text-purple-600': tenant.exitReason && tenant.exitReason.includes('Landlord'),
                                                        'text-amber-600': tenant.exitReason && tenant.exitReason.includes('Staff'),
                                                        'text-slate-800 font-bold': !tenant.name.toLowerCase().includes('vacant') && !tenant.exitReason
                                                      }"></span>
                                            </div>
                                        </template>
                                    </td>
                                    
                                    <!-- Phone -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <input type="tel" x-model="tenant.phone" 
                                                   placeholder="07XX XXX XXX"
                                                   class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <span x-text="tenant.phone || 'Not provided'" 
                                                  class="text-gray-600 text-sm"></span>
                                        </template>
                                    </td>
                                    
                                    <!-- Rent -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <input type="number" x-model="tenant.rent" 
                                                   class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <span class="font-bold text-slate-800" 
                                                  x-text="formatNumber(Number(tenant.rent))"></span>
                                        </template>
                                    </td>
                                    
                                    <!-- Deposit -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <input type="number" x-model="tenant.deposit" 
                                                   class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <span class="font-bold text-emerald-600" 
                                                  x-text="formatNumber(Number(tenant.deposit))"></span>
                                        </template>
                                    </td>
                                    
                                    <!-- Entry Date -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <input type="date" x-model="tenant.entryDate" 
                                                   class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <span x-text="tenant.entryDate || '-'" 
                                                  class="text-sm text-gray-600"></span>
                                        </template>
                                    </td>
                                    
                                    <!-- Exit Date -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <input type="date" x-model="tenant.exitDate" 
                                                   class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <span x-text="tenant.exitDate || '-'" 
                                                  :class="tenant.exitDate ? 'text-red-500' : 'text-gray-600'"
                                                  class="text-sm"></span>
                                        </template>
                                    </td>
                                    
                                    <!-- Notes/Reason -->
                                    <td class="px-6 py-4">
                                        <template x-if="editMode && userRole === 'owner'">
                                            <textarea x-model="tenant.exitReason" 
                                                      placeholder="Add notes or reason..."
                                                      rows="1"
                                                      class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition resize-none"></textarea>
                                        </template>
                                        <template x-if="!editMode || userRole !== 'owner'">
                                            <span x-text="tenant.exitReason || '-'" 
                                                  class="text-sm text-gray-500 italic"></span>
                                        </template>
                                    </td>
                                    
                                    <!-- Actions Column (Owner-only, Edit Mode only) -->
                                    <td class="px-6 py-4" x-show="userRole === 'owner' && editMode">
                                        <div class="flex items-center gap-2">
                                            <button @click="removeTenant(index)" 
                                                    class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition"
                                                    title="Remove tenant">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button @click="duplicateTenant(index)" 
                                                    class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 transition"
                                                    title="Duplicate tenant">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                            
                            <!-- Empty State -->
                            <template x-if="filteredTenants.length === 0">
                                <tr>
                                    <td colspan="9" class="px-6 py-12 text-center">
                                        <div class="flex flex-col items-center justify-center text-gray-400">
                                            <i class="fas fa-search text-4xl mb-4"></i>
                                            <p class="text-lg font-medium">No tenants found</p>
                                            <p class="text-sm mt-1" x-show="userRole === 'owner' && !editMode">
                                                Switch to <span class="font-bold">Edit Mode</span> to add tenants
                                            </p>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Footer -->
                <div class="border-t border-gray-100 bg-gray-50 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            <span x-text="filteredTenants.length"></span> units shown
                            <span x-show="searchQuery" class="text-blue-600 ml-2">
                                (filtered from <span x-text="(propertyData[selectedBuilding] || []).length"></span>)
                            </span>
                        </div>
                        <div class="flex items-center gap-6 text-sm">
                            <div>
                                <span class="text-gray-500">Building Total Rent:</span>
                                <span class="font-bold text-slate-800 ml-2">
                                    Ksh <span x-text="formatNumber(calculateBuildingTotal(selectedBuilding, 'rent'))"></span>
                                </span>
                            </div>
                            <div>
                                <span class="text-gray-500">Building Total Deposits:</span>
                                <span class="font-bold text-emerald-600 ml-2">
                                    Ksh <span x-text="formatNumber(calculateBuildingTotal(selectedBuilding, 'deposit'))"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions Footer -->
            <div class="mt-6 flex flex-wrap gap-4">
                <div x-show="userRole === 'owner' && editMode" class="flex items-center gap-4">
                    <button @click="saveAllChanges()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 transition">
                        <i class="fas fa-save"></i>
                        Save All Changes
                    </button>
                    <button @click="cancelEditMode()" 
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 transition">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
                
                <div class="flex gap-4 ml-auto">
                    <button @click="refreshData()" 
                            class="text-gray-600 hover:text-gray-800 font-medium flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Data
                    </button>
                    
                    <button @click="printReport()" 
                            class="text-gray-600 hover:text-gray-800 font-medium flex items-center gap-2">
                        <i class="fas fa-print"></i>
                        Print Report
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Success Toast -->
    <div x-show="showSuccessToast" 
         x-transition
         class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-40 flex items-center gap-3">
        <i class="fas fa-check-circle"></i>
        <span x-text="successMessage"></span>
    </div>

    <!-- Error Toast -->
    <div x-show="showErrorToast" 
         x-transition
         class="fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-40 flex items-center gap-3">
        <i class="fas fa-exclamation-circle"></i>
        <span x-text="errorMessage"></span>
    </div>

    <script>
        function managementSystem() {
            return {
                userRole: 'owner',
                selectedBuilding: '1. ROSALIA HOUSE',
                searchQuery: '',
                editMode: false,
                showSuccessToast: false,
                showErrorToast: false,
                successMessage: '',
                errorMessage: '',
                originalData: {},
                propertyData: {},

                init() {
                    const savedData = localStorage.getItem('eagles_management_data');
                    const savedRole = localStorage.getItem('userRole');
                    
                    if (savedRole) {
                        this.userRole = savedRole;
                    }
                    
                    if (savedData) {
                        this.propertyData = JSON.parse(savedData);
                    } else {
                        // Initialize with default data
                        this.propertyData = this.getDefaultPropertyData();
                        this.saveData();
                    }
                    
                    // Store original data for cancel functionality
                    this.originalData = JSON.parse(JSON.stringify(this.propertyData));
                },

                getDefaultPropertyData() {
                    // This is a simplified version - you should add your complete 31 buildings data here
                    return {
                        "1. ROSALIA HOUSE": [
                            { no: "1", name: "Paul Murimi", rent: 3000, deposit: 3000, phone: "", entryDate: "2025-01-01", exitDate: "", exitReason: "" },
                            { no: "2", name: "Vacant", rent: 1500, deposit: 0, phone: "", entryDate: "", exitDate: "", exitReason: "Vacant" },
                            { no: "3", name: "Occupied", rent: 3000, deposit: 3000, phone: "", entryDate: "2025-01-01", exitDate: "", exitReason: "" }
                        ],
                        "2. JOSPHINE NJAMBI": [
                            { no: "1", name: "Simon Ndungu", rent: 4150, deposit: 4150, phone: "", entryDate: "2025-01-01", exitDate: "", exitReason: "" },
                            { no: "2", name: "Irene Gichuki", rent: 3650, deposit: 3650, phone: "", entryDate: "2025-01-01", exitDate: "", exitReason: "" }
                        ]
                        // Add all 31 buildings here...
                    };
                },

                onRoleChange() {
                    localStorage.setItem('userRole', this.userRole);
                    
                    // If switching to secretary, ensure edit mode is off
                    if (this.userRole === 'secretary') {
                        this.editMode = false;
                        this.showToast('Switched to Secretary role - Read-only mode', 'success');
                    } else {
                        this.showToast('Switched to Owner role - Full edit permissions', 'success');
                    }
                },

                toggleEditMode() {
                    if (this.userRole !== 'owner') {
                        this.showToast('Only Owners can edit the ledger', 'error');
                        return;
                    }
                    
                    this.editMode = !this.editMode;
                    
                    if (this.editMode) {
                        // Store original data before editing
                        this.originalData = JSON.parse(JSON.stringify(this.propertyData));
                        this.showToast('Edit Mode Activated - Make your changes', 'success');
                    } else {
                        this.saveAllChanges();
                    }
                },

                addNewTenant() {
                    if (this.userRole !== 'owner' || !this.editMode) {
                        this.showToast('Switch to Edit Mode as Owner to add tenants', 'error');
                        return;
                    }
                    
                    const building = this.propertyData[this.selectedBuilding];
                    if (!building) {
                        this.propertyData[this.selectedBuilding] = [];
                    }
                    
                    // Generate next unit number
                    const existingUnits = this.propertyData[this.selectedBuilding].map(t => t.no);
                    let nextUnit = 1;
                    while (existingUnits.includes(nextUnit.toString())) {
                        nextUnit++;
                    }
                    
                    this.propertyData[this.selectedBuilding].push({
                        no: nextUnit.toString(),
                        name: "New Tenant",
                        rent: 0,
                        deposit: 0,
                        phone: "",
                        entryDate: new Date().toISOString().split('T')[0],
                        exitDate: "",
                        exitReason: ""
                    });
                    
                    this.showToast('New tenant row added', 'success');
                },

                removeTenant(index) {
                    if (this.userRole !== 'owner' || !this.editMode) {
                        return;
                    }
                    
                    if (confirm('Are you sure you want to remove this tenant?')) {
                        const building = this.propertyData[this.selectedBuilding];
                        if (building && building[index]) {
                            building.splice(index, 1);
                            this.showToast('Tenant removed', 'success');
                        }
                    }
                },

                duplicateTenant(index) {
                    if (this.userRole !== 'owner' || !this.editMode) {
                        return;
                    }
                    
                    const building = this.propertyData[this.selectedBuilding];
                    if (building && building[index]) {
                        const tenant = building[index];
                        const duplicate = JSON.parse(JSON.stringify(tenant));
                        duplicate.no = (parseInt(tenant.no) || 0) + 1;
                        duplicate.name = duplicate.name + " (Copy)";
                        
                        building.splice(index + 1, 0, duplicate);
                        this.showToast('Tenant duplicated', 'success');
                    }
                },

                saveAllChanges() {
                    if (this.userRole !== 'owner') {
                        return;
                    }
                    
                    this.saveData();
                    this.editMode = false;
                    this.showToast('All changes saved successfully', 'success');
                },

                cancelEditMode() {
                    if (confirm('Cancel all unsaved changes?')) {
                        this.propertyData = JSON.parse(JSON.stringify(this.originalData));
                        this.editMode = false;
                        this.showToast('Changes cancelled', 'success');
                    }
                },

                get filteredTenants() {
                    let currentData = this.propertyData[this.selectedBuilding] || [];
                    if (!this.searchQuery.trim()) return currentData;
                    
                    const query = this.searchQuery.toLowerCase();
                    return currentData.filter(t => 
                        t.name.toLowerCase().includes(query) || 
                        t.no.toLowerCase().includes(query) ||
                        (t.phone && t.phone.toLowerCase().includes(query))
                    );
                },

                getStats() {
                    let totalRent = 0;
                    let totalDeposits = 0;
                    let totalUnits = 0;
                    let occupied = 0;

                    Object.values(this.propertyData).forEach(units => {
                        units.forEach(u => {
                            totalUnits++;
                            totalRent += Number(u.rent || 0);
                            totalDeposits += Number(u.deposit || 0);
                            if (!u.name.toLowerCase().includes('vacant') && u.name !== 'Vacant' && !u.exitReason?.includes('Landlord') && !u.exitReason?.includes('Staff')) {
                                occupied++;
                            }
                        });
                    });

                    return {
                        totalRent,
                        totalDeposits,
                        occupancy: totalUnits > 0 ? Math.round((occupied / totalUnits) * 100) : 0,
                        totalUnits,
                        occupied
                    };
                },

                calculateBuildingTotal(buildingName, field) {
                    const units = this.propertyData[buildingName] || [];
                    return units.reduce((total, unit) => total + Number(unit[field] || 0), 0);
                },

                formatNumber(num) {
                    return num.toLocaleString('en-KE');
                },

                refreshData() {
                    location.reload();
                },

                exportData() {
                    const dataStr = JSON.stringify(this.propertyData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `eagle-homes-data-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('Data exported successfully', 'success');
                },

                printReport() {
                    window.print();
                },

                saveData() {
                    localStorage.setItem('eagles_management_data', JSON.stringify(this.propertyData));
                },

                showToast(message, type = 'success') {
                    if (type === 'success') {
                        this.successMessage = message;
                        this.showSuccessToast = true;
                        setTimeout(() => this.showSuccessToast = false, 3000);
                    } else {
                        this.errorMessage = message;
                        this.showErrorToast = true;
                        setTimeout(() => this.showErrorToast = false, 3000);
                    }
                },

                logout() {
                    if (confirm('Are you sure you want to logout?')) {
                        localStorage.removeItem('userRole');
                        window.location.href = 'index.html';
                    }
                }
            };
        }
    </script>
</body>
</html>
