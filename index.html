<script>
function loginApp() {
  return {
    // Login state
    role: 'owner',
    username: '',
    password: '',
    
    // Reset password state
    showResetModal: false,
    resetStep: 1,
    resetEmail: '',
    resetCode: '',
    newPassword: '',
    confirmPassword: '',
    isSending: false,
    isVerifying: false,
    isUpdating: false,
    
    // Notifications
    showSuccess: false,
    showError: false,
    successTitle: '',
    successMessage: '',
    errorTitle: '',
    errorMessage: '',
    
    // EmailJS Configuration - IMPORTANT: Store these server-side in production
    emailjsConfig: {
      serviceId: 'service_l8mddbx',
      templateId: 'template_va2rli4',
      publicKey: 'mxImeKQYfA_aBo1hp'
    },
    
    // Initialize
    async init() {
      console.log('Eagle Homes Login System Initialized');
      
      // Wait for EmailJS to load
      if (typeof emailjs === 'undefined') {
        console.error('EmailJS not loaded yet');
        // Retry after a delay
        setTimeout(() => this.initEmailJS(), 1000);
        return;
      }
      
      await this.initEmailJS();
      this.checkResetToken();
    },
    
    // Initialize EmailJS
    async initEmailJS() {
      try {
        if (typeof emailjs !== 'undefined') {
          // Initialize with timeout to handle loading issues
          await emailjs.init(this.emailjsConfig.publicKey);
          console.log('EmailJS initialized successfully');
        }
      } catch (error) {
        console.error('EmailJS initialization failed:', error);
        // Fallback: EmailJS will try to auto-initialize
      }
    },
    
    // Check for reset token in URL
    checkResetToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      
      if (token) {
        try {
          // Decode the token from URL
          const data = JSON.parse(atob(token));
          
          // Check if token is expired (15 minutes)
          const isExpired = Date.now() > (data.expiry || 0);
          
          if (data.email && data.code && !isExpired) {
            this.resetEmail = data.email;
            this.role = data.role || 'owner';
            this.resetCode = data.code;
            this.resetStep = 2;
            this.showResetModal = true;
            
            this.showSuccessNotification(
              'Reset Link Opened',
              'Please enter the 6-digit code from your email'
            );
            
            // Remove token from URL without reloading
            window.history.replaceState({}, document.title, window.location.pathname);
          } else {
            this.showErrorNotification(
              'Link Expired',
              'This reset link has expired. Please request a new one.'
            );
          }
        } catch (e) {
          console.error('Invalid reset token:', e);
          this.showErrorNotification(
            'Invalid Link',
            'This reset link is invalid. Please request a new one.'
          );
        }
      }
    },
    
    // Send reset email using EmailJS
    async sendResetEmail() {
      if (!this.resetEmail || !this.resetEmail.includes('@')) {
        this.showErrorNotification('Invalid Email', 'Please enter a valid email address');
        return;
      }
      
      this.isSending = true;
      
      // Generate 6-digit code
      const resetCode = Math.floor(100000 + Math.random() * 900000).toString();
      
      // Create reset token (expires in 15 minutes)
      const resetData = {
        email: this.resetEmail,
        code: resetCode,
        expiry: Date.now() + (15 * 60 * 1000), // 15 minutes
        role: this.role,
        ip: await this.getClientIP()
      };
      
      // Create reset link
      const resetToken = btoa(JSON.stringify(resetData));
      const resetLink = `${window.location.origin}${window.location.pathname}?token=${resetToken}`;
      
      // Store reset data in localStorage for verification (with expiration)
      resetData.storedAt = Date.now();
      localStorage.setItem('resetData', JSON.stringify(resetData));
      
      // Also store in sessionStorage as backup
      sessionStorage.setItem('resetEmail', this.resetEmail);
      
      // Prepare data for EmailJS
      const templateParams = {
        to_email: this.resetEmail,
        reset_code: resetCode,
        reset_link: resetLink,
        user_email: this.resetEmail,
        user_role: this.role,
        expiry_time: '15 minutes'
      };
      
      console.log('Sending reset email...');
      
      try {
        // First, save reset request to server for validation
        const serverResponse = await fetch('login_process.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'save_reset_request',
            email: this.resetEmail,
            role: this.role,
            code: resetCode,
            ip: resetData.ip
          })
        });
        
        const serverData = await serverResponse.json();
        
        if (!serverData.success) {
          throw new Error(serverData.message || 'Server validation failed');
        }
        
        // Send email via EmailJS
        const response = await emailjs.send(
          this.emailjsConfig.serviceId,
          this.emailjsConfig.templateId,
          templateParams
        );
        
        console.log('EmailJS Response:', response);
        
        // Move to next step
        this.resetStep = 2;
        this.showSuccessNotification(
          'Email Sent!',
          `We've sent a password reset email to ${this.resetEmail}. Check your inbox (and spam folder).`
        );
        
      } catch (error) {
        console.error('EmailJS Error:', error);
        
        // Try server-side fallback method
        await this.tryServerSideEmail(resetCode, resetLink, error);
        
      } finally {
        this.isSending = false;
      }
    },
    
    // Server-side fallback email method
    async tryServerSideEmail(code, link, originalError) {
      console.log('Trying server-side email fallback...');
      
      try {
        const response = await fetch('login_process.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'send_reset_email',
            email: this.resetEmail,
            role: this.role,
            code: code,
            link: link
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          this.resetStep = 2;
          this.showSuccessNotification(
            'Email Sent!',
            `We've sent a password reset email to ${this.resetEmail}. Check your inbox.`
          );
        } else {
          throw new Error(data.message || 'Server-side email failed');
        }
      } catch (fallbackError) {
        console.error('Fallback email error:', fallbackError);
        
        // If both methods fail, show error but don't reveal details
        this.showErrorNotification(
          'Email Error',
          'Failed to send reset email. Please try again in a few minutes.'
        );
      }
    },
    
    // Get client IP for security logging
    async getClientIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        return 'unknown';
      }
    },
    
    // Verify reset code
    verifyResetCode() {
      if (!this.resetCode || this.resetCode.length !== 6) {
        this.showErrorNotification('Invalid Code', 'Please enter the 6-digit code from your email');
        return;
      }
      
      this.isVerifying = true;
      
      // Get stored reset data
      const storedData = JSON.parse(localStorage.getItem('resetData') || '{}');
      
      // Check localStorage first
      if (storedData.email && storedData.code && storedData.expiry) {
        this.verifyLocalCode(storedData);
      } else {
        // If not in localStorage, check with server
        this.verifyServerCode();
      }
    },
    
    // Verify code from localStorage
    verifyLocalCode(storedData) {
      // Check if code is expired
      if (storedData.expiry < Date.now()) {
        this.showErrorNotification('Code Expired', 'Reset code has expired. Please request a new one.');
        this.resetStep = 1;
        localStorage.removeItem('resetData');
        sessionStorage.removeItem('resetEmail');
        this.isVerifying = false;
        return;
      }
      
      if (storedData.email !== this.resetEmail) {
        this.showErrorNotification('Email Mismatch', 'Please use the email you requested the reset with');
        this.isVerifying = false;
        return;
      }
      
      if (storedData.code !== this.resetCode) {
        this.showErrorNotification('Invalid Code', 'The code you entered is incorrect. Please check your email.');
        this.resetCode = '';
        this.isVerifying = false;
        return;
      }
      
      // Code is valid
      this.isVerifying = false;
      this.resetStep = 3;
      this.showSuccessNotification(
        'Code Verified!',
        'Now set your new password'
      );
    },
    
    // Verify code with server
    async verifyServerCode() {
      try {
        const response = await fetch('login_process.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'verify_reset_code',
            email: this.resetEmail,
            code: this.resetCode,
            role: this.role
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          this.isVerifying = false;
          this.resetStep = 3;
          this.showSuccessNotification(
            'Code Verified!',
            'Now set your new password'
          );
        } else {
          this.showErrorNotification('Invalid Code', data.message || 'The code you entered is incorrect.');
          this.resetCode = '';
          this.isVerifying = false;
        }
      } catch (error) {
        console.error('Server verification error:', error);
        this.showErrorNotification('Verification Failed', 'Could not verify code. Please try again.');
        this.isVerifying = false;
      }
    },
    
    // Update password
    async updatePassword() {
      if (this.newPassword.length < 8) {
        this.showErrorNotification('Weak Password', 'Password must be at least 8 characters long');
        return;
      }
      
      if (this.newPassword !== this.confirmPassword) {
        this.showErrorNotification('Password Mismatch', 'Passwords do not match');
        return;
      }
      
      // Check password strength
      const strongRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
      if (!strongRegex.test(this.newPassword)) {
        this.showErrorNotification(
          'Weak Password', 
          'Password must contain uppercase, lowercase, number, and special character'
        );
        return;
      }
      
      this.isUpdating = true;
      
      try {
        // Get stored reset data
        const storedData = JSON.parse(localStorage.getItem('resetData') || '{}');
        
        if (!storedData.email) {
          // Try sessionStorage as fallback
          storedData.email = sessionStorage.getItem('resetEmail') || this.resetEmail;
        }
        
        // Send to PHP backend to update password
        const
